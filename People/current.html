<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Current Members | SFPL</title>
  <link rel="stylesheet" href="../styles.css" />
</head>

<body class="page-flex">

  <!-- ✅ 공통 헤더 삽입 위치 -->
  <div id="site-header"></div>

  <main>
    <div class="container page-wrap">
      <h1 class="page-title">Current members</h1>
      <p><div id="currentGrid" class="people-grid" aria-label="Current members list"></div></p>
    </div>
  </main>

<div id="site-footer"></div>


<script>
  // ✅ Current members JSON 로드 & 렌더
  (function () {
    const wrap = document.getElementById("currentGrid");
    if (!wrap) return;

    function el(tag, cls, text) {
      const x = document.createElement(tag);
      if (cls) x.className = cls;
      if (text != null) x.textContent = text;
      return x;
    }

    function pickMembers(data) {
      if (Array.isArray(data.members)) return data.members;
      if (Array.isArray(data.people)) return data.people;
      if (Array.isArray(data.items)) return data.items;
      return [];
    }

    function pickSrc(v) {
      if (!v) return "";
      if (typeof v === "string") return v;
      if (typeof v === "object" && v.src) return v.src;
      return "";
    }
    // ===== Netlify Image CDN (용량만 줄이기) =====
function isHttpUrl(p) {
  return /^https?:\/\//i.test(String(p));
}

// 로컬 경로면 /.netlify/images 로 최적화해서 내려받기
function nlImg(url, w, q = 72, fm = "webp") {
  if (!url) return "";
  const s = String(url).trim();
  if (!s) return "";
  if (isHttpUrl(s)) return s; // 외부 URL은 그대로
  const u = encodeURI(s.startsWith("/") ? s : ("/" + s)); // "/" 유지
  return `/.netlify/images?url=${u}&w=${w}&q=${q}&fm=${fm}`;
}

// 현재 페이지(/people/current.html) 기준으로 상대경로를 "절대경로"로 변환
// 예: "../content/a.jpg" -> "/content/a.jpg"
function toAbsPath(p){
  if (!p) return "";
  const s = String(p).trim();
  if (!s) return "";
  if (isHttpUrl(s)) return s;
  return new URL(s, window.location.href).pathname.replace(/\/\/+/g, "/");
}
    
    function addLabeledRow(parent, labelText, valueText, cls) {
      if (!valueText) return;
      const row = el("div", cls || "person-row");
      row.appendChild(el("span", "label", labelText));
      row.appendChild(el("span", "value", valueText));
      parent.appendChild(row);
    }

    function renderCard(m) {
      const card = el("article", "person-card");

      // 왼쪽 사진
const imgSrc = pickSrc(m.photo || m.image || m.avatar);
if (imgSrc) {
  const img = document.createElement("img");
  img.className = "person-photo";

  const abs = toAbsPath(imgSrc);

  if (abs && abs.startsWith("/")) {
    // 로컬 파일이면 Netlify Image CDN으로 최적화
    img.src = nlImg(abs, 720);
    img.srcset = `${nlImg(abs, 360)} 360w, ${nlImg(abs, 720)} 720w, ${nlImg(abs, 960)} 960w`;
    img.sizes = "(max-width: 640px) 92vw, 520px";
  } else {
    // 외부 URL이면 그대로 사용
    img.src = abs || imgSrc;
  }

  img.alt = m.name ? `${m.name} photo` : "member photo";
  img.loading = "lazy";
  img.decoding = "async";

  card.appendChild(img);
}

      // 오른쪽 텍스트 영역
      const text = el("div", "person-text");
      card.appendChild(text);

      // 이름
      text.appendChild(el("div", "person-name", m.name || "Unnamed"));

      // 학위/학력 (config.yml에 bs, ms가 있으니 출력)  :contentReference[oaicite:0]{index=0}
      const bsText = m.bs || "";
      const msText = m.ms || "";
      if (bsText || msText) {
        const edu = el("div", "person-edu");
        if (bsText) edu.appendChild(el("div", "edu-line", "B.S.: " + bsText));
        if (msText) edu.appendChild(el("div", "edu-line", "M.S./Ph.D.: " + msText));
        text.appendChild(edu);
      }

      // ✅ Research (필드명이 research로 들어오므로 최우선 출력)
      // 혹시 다른 키로 들어오는 경우도 대비해서 fallback 허용
      const researchText =
        m.research || m.research_field || m.field || m.interest || m.topic || "";
      addLabeledRow(text, "Research:", researchText, "person-research");

      // Bio
    const bioText = m.bio || "";
if (bioText) {
  const row = el("div", "person-bio");
  row.innerHTML = `<span class="label">자기소개:</span> <span class="value"></span>`;
  row.querySelector(".value").textContent = bioText;
  text.appendChild(row);
}


      // ✅ Email: 하이퍼링크 제거 (그냥 텍스트로 출력)
const emailText = m.email || "";
if (emailText) {
  const row = el("div", "person-email");
  row.appendChild(el("span", "label", "Email:"));
  row.appendChild(el("span", "value", emailText)); // ✅ 텍스트로만 출력
  text.appendChild(row);
}


      return card;
    }

    async function load() {
      try {
        const url = "../content/current.json?v=" + Date.now();
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("current.json load failed: " + res.status);

        const data = await res.json();
        const members = pickMembers(data);

        wrap.innerHTML = "";
        if (!members.length) {
          wrap.appendChild(el("div", "people-empty", "등록된 Current 멤버가 없습니다."));
          return;
        }

        members.forEach(m => wrap.appendChild(renderCard(m)));
      } catch (e) {
        console.error(e);
        wrap.innerHTML = `<div class="people-empty">데이터를 불러오지 못했습니다. (../content/current.json 확인)</div>`;
      }
    }

    load();
  })();

  /* footer year */
  const y = document.getElementById("year");
  if (y) y.textContent = new Date().getFullYear();

  /* header load (people/current.html → 상위 폴더) */
  fetch("../header.html")
    .then(res => {
      if (!res.ok) throw new Error("header.html load failed");
      return res.text();
    })
    .then(html => {
      document.getElementById("site-header").innerHTML = html;

      document.querySelectorAll(".nav-link").forEach(a => a.classList.remove("active"));
      const desk = document.querySelector(
        '.nav-link[href="/people/current.html"], .nav-link[href="../people/current.html"]'
      );
      if (desk) desk.classList.add("active");

      const mob = document.querySelector(
        '#mobileNav .m-link[href="/people/current.html"], #mobileNav .m-link[href="../people/current.html"]'
      );
      if (mob) mob.classList.add("active");

      const btn = document.querySelector(".nav-toggle");
      const mobileNav = document.getElementById("mobileNav");
      if (btn && mobileNav) {
        btn.addEventListener("click", () => {
          const open = mobileNav.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(open));
        });
      }

      document
        .querySelectorAll(".dropdown-toggle, .mobile-nav .m-link[href='#']")
        .forEach(el => el.addEventListener("click", e => e.preventDefault()));

      document
        .querySelectorAll("#mobileNav [data-toggle='sub']")
        .forEach(t => {
          t.addEventListener("click", e => {
            e.preventDefault();
            const sub = t.nextElementSibling;
            if (sub && sub.classList.contains("m-sub")) sub.classList.toggle("open");
          });
        });
    })
    .catch(err => console.error(err));

    fetch("../footer.html")
  .then(res => {
    if (!res.ok) throw new Error("footer.html load failed");
    return res.text();
  })
  .then(html => {
    document.getElementById("site-footer").innerHTML = html;
    const y = document.getElementById("year");
    if (y) y.textContent = new Date().getFullYear();
  })
  .catch(err => console.error(err));

</script>



</body>
</html>
