<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photo | SFPL</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="page-flex">
  <div id="site-header"></div>

  <main class="page-wrap photo-wrap">
    <div class="photo-container">
      <h1 class="page-title">Photos</h1>
      <section id="photoGrid" class="photo-grid"></section>
    </div>
  </main>

  <div id="site-footer"></div>

  <script>
  // ===== GitHub Pages(/<repo>/...) + Custom domain(/) 모두 대응 basePrefix =====
  // - 커스텀 도메인: basePrefix="/"
  // - GitHub Pages(user.github.io/<repo>/...): basePrefix="/<repo>/"
  const basePrefix = (() => {
    const parts = location.pathname.split("/").filter(Boolean);
    if (location.hostname.endsWith("github.io")) {
      const repo = parts[0] || "";
      return "/" + repo + "/";
    }
    return "/";
  })();

  // ===== header load =====
  fetch(basePrefix + "header.html")
    .then(res => { if (!res.ok) throw new Error("header.html load failed"); return res.text(); })
    .then(html => {
      document.getElementById("site-header").innerHTML = html;

      const btn = document.querySelector(".nav-toggle");
      const mobileNav = document.getElementById("mobileNav");
      if (btn && mobileNav) {
        btn.addEventListener("click", () => {
          const open = mobileNav.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(open));
        });
      }

      document
        .querySelectorAll(".dropdown-toggle, .mobile-nav .m-link[href='#']")
        .forEach(el => el.addEventListener("click", e => e.preventDefault()));

      document
        .querySelectorAll("#mobileNav [data-toggle='sub']")
        .forEach(t => {
          t.addEventListener("click", e => {
            e.preventDefault();
            const sub = t.nextElementSibling;
            if (sub && sub.classList.contains("m-sub")) sub.classList.toggle("open");
          });
        });
    })
    .catch(console.error);

  // ===== footer load =====
  fetch(basePrefix + "footer.html")
    .then(res => { if (!res.ok) throw new Error("footer.html load failed"); return res.text(); })
    .then(html => {
      document.getElementById("site-footer").innerHTML = html;
      const y = document.getElementById("year");
      if (y) y.textContent = new Date().getFullYear();
    })
    .catch(console.error);

  // ===== inject CSS for layout + carousel =====
  (function ensurePhotoCSSOnce(){
    if (document.getElementById("photoCarouselCSS")) return;
    const style = document.createElement("style");
    style.id = "photoCarouselCSS";
    style.textContent = `
      main.page-wrap { margin-top: 5px !important; }

      .photo-grid{
        display:grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 26px;
        align-items: start;
      }
      @media (max-width: 820px){
        .photo-grid{ grid-template-columns: 1fr; gap: 18px; }
      }

      .album-card{
        border: 1px solid rgba(0,0,0,.08);
        border-radius: 16px;
        padding: 16px;
        background: #fff;
      }
      .album-title{
        margin: 0 0 12px;
        font-size: 24px;
        letter-spacing: -0.02em;
      }
      .album-date{
        font-size: 13px;
        color: rgba(0,0,0,.55);
        margin-bottom: 6px;
      }

      .carousel{ position: relative; width: 100%; }
      .carousel-track{
        display:flex;
        overflow-x:auto;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        gap: 12px;
        padding: 6px 2px 4px;
        scrollbar-width: none;
      }
      .carousel-track::-webkit-scrollbar{ display:none; }
      .carousel-slide{ flex: 0 0 100%; scroll-snap-align: center; }

      .carousel-img{
        width:100%;
        height:auto;
        display:block;
        border-radius: 14px;
        object-fit: contain;
        object-position: center top;
      }

      .carousel-dots{
        display:flex;
        justify-content:center;
        gap: 8px;
        padding: 10px 0 2px;
      }
      .dot{
        width: 7px; height: 7px;
        border-radius: 999px;
        background: rgba(0,0,0,.25);
        border: 0;
        padding: 0;
        cursor: pointer;
      }
      .dot.active{ background: rgba(0,0,0,.75); }

      .carousel-controls{
        display:grid;
        grid-template-columns: 36px 1fr 36px;
        align-items:center;
        gap: 10px;
        margin-top: 6px;
      }
      .carousel-btn{
        width: 36px; height: 36px;
        border-radius: 10px;
        border: 1px solid rgba(0,0,0,.15);
        background: #fff;
        cursor: pointer;
        font-size: 20px;
        line-height: 1;
      }
      @media (max-width: 640px){
        .carousel-controls{ grid-template-columns: 1fr; }
        .carousel-btn{ display:none; }
      }

      .album-empty, .album-empty-wide{
        padding: 14px 0;
        color: rgba(0,0,0,.6);
      }
    `;
    document.head.appendChild(style);
  })();

  // ===== helpers =====
  const GH_OWNER  = "crchoi0305";
  const GH_REPO   = "SFPL";
  const GH_BRANCH = "main";
  const GH_RAW_BASE = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}`;

  const grid = document.getElementById("photoGrid");

  function el(tag, cls, html) {
    const n = document.createElement(tag);
    if (cls) n.className = cls;
    if (html !== undefined) n.innerHTML = html;
    return n;
  }

  function isHttpUrl(p) {
    return /^https?:\/\//i.test(String(p));
  }

  function nlImg(url, w, q = 72, fm = "webp") {
  if (!url) return "";
  const s = String(url).trim();
  if (!s) return "";
  if (/^https?:\/\//i.test(s)) return s; // 외부 URL은 그대로
  const u = encodeURI(s.startsWith("/") ? s : ("/" + s)); // "/" 유지
  return `/.netlify/images?url=${u}&w=${w}&q=${q}&fm=${fm}`;
}
  // ✅ date: "YYYY.MM.DD" 형태에 정확히 맞는 파서
  function parseAlbumDate(d){
    if (!d) return 0;
    const s = String(d).trim().replace(/\./g, "-"); // 2024.04.03 -> 2024-04-03
    const t = Date.parse(s);
    return Number.isFinite(t) ? t : 0;
  }

  // ✅ rel 정규화: content/content 제거 + leading slash 처리
  function normalizeRelPath(p){
    let rel = String(p || "").trim();
    rel = rel.replace(/^https?:\/\/[^/]+\/?/, ""); // 혹시 도메인이 섞여오면 제거(안전)
    rel = rel.replace(/^\/+/, "");                // "/content/..." -> "content/..."
    rel = rel.replace(/^content\/content\//, "content/");
    rel = rel.replace(/^\.?\//, "");
    return rel;
  }

  // ===== 이미지: "절대경로(/content/...)" 우선 + 실패 시 raw fallback =====
  function resolveImgSources(v) {
    if (!v) return { primary: "", fallback: "" };

    const src =
      (typeof v === "string") ? v :
      (v && typeof v === "object" ? (v.image || v.src || "") : "");

    const s = String(src || "").trim();
    if (!s) return { primary: "", fallback: "" };

    // 1) 외부 URL이면 그대로 (fallback 없음)
    if (isHttpUrl(s) && !s.startsWith(GH_RAW_BASE + "/")) {
      return { primary: s, fallback: "" };
    }

    // 2) raw URL로 저장된 경우: rel 뽑아서 로컬(/content/...) 먼저, raw fallback
    if (isHttpUrl(s) && s.startsWith(GH_RAW_BASE + "/")) {
      let rel = s.slice((GH_RAW_BASE + "/").length); // e.g. content/assets/photos/...
      rel = normalizeRelPath(rel);

      const primary = (basePrefix + rel).replace(/\/\/+/, "/"); // GitHub Pages 대응
      const fallback = s;
      return { primary, fallback };
    }

    // 3) 로컬 경로: JSON이 "/content/assets/photos/..." 형태라면
    //    -> primary는 그대로, fallback은 raw로
    const rel = normalizeRelPath(s);
    const primary = s.startsWith("/") ? s : (basePrefix + rel).replace(/\/\/+/, "/");
    const fallback = `${GH_RAW_BASE}/${rel}`;
    return { primary, fallback };
  }

  function setImgWithFallback(img, sources) {
  if (!img || !sources) return;

  const primary = sources.primary || "";
  const fallback = sources.fallback || "";

  // primary가 로컬 절대경로면 Netlify Image CDN으로 최적화해서 로드
  if (primary && String(primary).trim().startsWith("/")) {
    img.src = nlImg(primary, 1200);
    img.srcset = `${nlImg(primary, 800)} 800w, ${nlImg(primary, 1200)} 1200w, ${nlImg(primary, 1600)} 1600w`;
    img.sizes = "(max-width: 820px) 100vw, 50vw";
  } else {
    // 외부 URL 등은 원래대로
    img.src = primary || fallback || "";
  }

  img.loading = "lazy";
  img.decoding = "async";

  // 실패 시 raw fallback로 1회 전환
  img.onerror = () => {
    if (fallback && img.src !== fallback) {
      img.src = fallback;
      return;
    }
    img.onerror = null;
  };
}

  function scrollToIndex(track, i){
    const slides = track.querySelectorAll(".carousel-slide");
    const idx = Math.max(0, Math.min(slides.length - 1, i));
    const target = slides[idx];
    const left = target.offsetLeft - track.offsetLeft;
    track.scrollTo({ left, behavior: "smooth" });
    track.dataset.index = String(idx);
  }

  function setActiveDot(dots, idx){
    [...dots.children].forEach((d, k) => d.classList.toggle("active", k === idx));
  }

  function bindScrollSync(track, dots){
    let raf = null;
    const slides = () => [...track.querySelectorAll(".carousel-slide")];

    track.addEventListener("scroll", () => {
      if (raf) cancelAnimationFrame(raf);
      raf = requestAnimationFrame(() => {
        const ss = slides();
        if (!ss.length) return;

        const center = track.scrollLeft + track.clientWidth / 2;
        let bestIdx = 0;
        let bestDist = Infinity;

        ss.forEach((s, i) => {
          const sCenter = (s.offsetLeft - track.offsetLeft) + s.clientWidth / 2;
          const dist = Math.abs(center - sCenter);
          if (dist < bestDist) { bestDist = dist; bestIdx = i; }
        });

        track.dataset.index = String(bestIdx);
        setActiveDot(dots, bestIdx);
      });
    }, { passive: true });
  }

  // ===== build album carousel =====
  function buildCarousel(album) {
    const card = el("article", "album-card");

    const header = el("div", "album-header");

    if (album.date) {
      const dateText = el("div", "album-date");
      dateText.textContent = String(album.date);
      header.appendChild(dateText);
    }

    const title = el("h2", "album-title");
    title.textContent = album.title || "Untitled";
    header.appendChild(title);

    card.appendChild(header);

    const wrap = el("div", "carousel");
    const track = el("div", "carousel-track");
    track.dataset.index = "0";

    const raw = Array.isArray(album.images) ? album.images : [];
    const imgs = raw.map(resolveImgSources).filter(o => (o && (o.primary || o.fallback)));

    imgs.forEach((sources, i) => {
      const slide = el("div", "carousel-slide");
      const img = document.createElement("img");
      img.className = "carousel-img";
      setImgWithFallback(img, sources);
      img.alt = `${album.title || "Album"} - ${i + 1}`;
      img.loading = "lazy";
      slide.appendChild(img);
      track.appendChild(slide);
    });

    wrap.appendChild(track);
    card.appendChild(wrap);

    if (!imgs.length) {
      card.appendChild(el("div", "album-empty", "등록된 사진이 없습니다."));
      return card;
    }

    const dots = el("div", "carousel-dots");
    imgs.forEach((_, i) => {
      const d = el("button", "dot" + (i === 0 ? " active" : ""), "");
      d.type = "button";
      d.addEventListener("click", () => scrollToIndex(track, i));
      dots.appendChild(d);
    });

    const controls = el("div", "carousel-controls");
    const prev = el("button", "carousel-btn", "‹");
    const next = el("button", "carousel-btn", "›");
    prev.type = next.type = "button";

    prev.addEventListener("click", () => {
      const cur = parseInt(track.dataset.index || "0", 10);
      scrollToIndex(track, cur - 1);
    });
    next.addEventListener("click", () => {
      const cur = parseInt(track.dataset.index || "0", 10);
      scrollToIndex(track, cur + 1);
    });

    controls.appendChild(prev);
    controls.appendChild(dots);
    controls.appendChild(next);
    card.appendChild(controls);

    bindScrollSync(track, dots);

    return card;
  }

  // ===== init =====
  async function init() {
    try {
      const res = await fetch(basePrefix + "content/photos.json?v=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error("photos.json load failed");

      const data = await res.json();
      const albums = Array.isArray(data.albums) ? data.albums.slice() : [];

      if (!albums.length) {
        grid.appendChild(el("div", "album-empty-wide", "등록된 앨범이 없습니다."));
        return;
      }

      // ✅ 날짜 최신순(내림차순)
      albums.sort((a, b) => parseAlbumDate(b.date) - parseAlbumDate(a.date));

      albums.forEach(a => grid.appendChild(buildCarousel(a)));
    } catch (e) {
      console.error(e);
      grid.appendChild(el("div", "album-empty-wide", "Photo 데이터를 불러오지 못했습니다. (content/photos.json 확인)"));
    }
  }

  init();
  </script>
</body>
</html>
