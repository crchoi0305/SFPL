<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photo | SFPL</title>
  <!-- ✅ GitHub Pages(/repo/...)에서도 깨지지 않도록 경로는 JS에서 base를 계산해 보정 -->
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="page-flex">

  <!-- ✅ 공통 헤더 삽입 위치 -->
  <div id="site-header"></div>

<main class="page-wrap photo-wrap">
  <div class="photo-container">
    <h1 class="page-title">Photos</h1>
    <section id="photoGrid" class="photo-grid"></section>
  </div>
</main>

<div id="site-footer"></div>


  <script>
  // ===== footer year =====
  const y = document.getElementById("year");
  if (y) y.textContent = new Date().getFullYear();

  // ===== GitHub Pages(/<repo>/...) 호스팅 대비 base prefix 계산 =====
  // 예) https://user.github.io/repo/photo.html  -> basePrefix = "/repo/"
  // 예) https://domain.com/photo.html          -> basePrefix = "/"
  const basePrefix = (() => {
    const p = location.pathname;
    return p.endsWith('/') ? p : p.replace(/\/[^\/]*$/, '/')
  })();

  // ===== header load =====
  fetch(basePrefix + "header.html")
    .then(res => {
      if (!res.ok) throw new Error("header.html load failed");
      return res.text();
    })
    .then(html => {
      document.getElementById("site-header").innerHTML = html;

      const btn = document.querySelector(".nav-toggle");
      const mobileNav = document.getElementById("mobileNav");
      if (btn && mobileNav) {
        btn.addEventListener("click", () => {
          const open = mobileNav.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(open));
        });
      }

      document
        .querySelectorAll(".dropdown-toggle, .mobile-nav .m-link[href='#']")
        .forEach(el => el.addEventListener("click", e => e.preventDefault()));

      document
        .querySelectorAll("#mobileNav [data-toggle='sub']")
        .forEach(t => {
          t.addEventListener("click", e => {
            e.preventDefault();
            const sub = t.nextElementSibling;
            if (sub && sub.classList.contains("m-sub")) sub.classList.toggle("open");
          });
        });
    })
    .catch(err => console.error(err));

    fetch(basePrefix + "footer.html")
  .then(res => {
    if (!res.ok) throw new Error("footer.html load failed");
    return res.text();
  })
  .then(html => {
    document.getElementById("site-footer").innerHTML = html;
    const y = document.getElementById("year");
    if (y) y.textContent = new Date().getFullYear();
  })
  .catch(err => console.error(err));


  // ===== inject CSS for layout + carousel =====
  (function ensurePhotoCSSOnce(){
    if (document.getElementById("photoCarouselCSS")) return;
    const style = document.createElement("style");
    style.id = "photoCarouselCSS";
    style.textContent = `
      /* ✅ page wrapper: max 1200, center, header gap 5px */
      main.page-wrap { margin-top: 5px !important; }
      main.page-wrap .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* ✅ album grid: desktop 2 columns, mobile 1 column */
      .photo-grid{
        display:grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 26px;
        align-items: start;
      }
      @media (max-width: 820px){
        .photo-grid{ grid-template-columns: 1fr; gap: 18px; }
      }

      .album-card{
        border: 1px solid rgba(0,0,0,.08);
        border-radius: 16px;
        padding: 16px;
        background: #fff;
      }
      .album-title{
        margin: 0 0 12px;
        font-size: 24px;
        letter-spacing: -0.02em;
      }

      /* ✅ carousel (works for both desktop + mobile, swipe on mobile) */
      .carousel{
        position: relative;
        width: 100%;
      }
      .carousel-track{
        display:flex;
        overflow-x:auto;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        gap: 12px;
        padding: 6px 2px 4px;
        scrollbar-width: none;
      }
      .carousel-track::-webkit-scrollbar{ display:none; }

      .carousel-slide{
        flex: 0 0 100%;
        scroll-snap-align: center;
      }

      .carousel-img{
        width:100%;
        height:auto;
        display:block;
        border-radius: 14px;
        object-fit: contain;
        object-position: center top;
      }

      /* ✅ dots */
      .carousel-dots{
        display:flex;
        justify-content:center;
        gap: 8px;
        padding: 10px 0 2px;
      }
      .dot{
        width: 7px; height: 7px;
        border-radius: 999px;
        background: rgba(0,0,0,.25);
        border: 0;
        padding: 0;
        cursor: pointer;
      }
      .dot.active{ background: rgba(0,0,0,.75); }

      /* ✅ optional arrows (desktop convenience) */
      .carousel-controls{
        display:grid;
        grid-template-columns: 36px 1fr 36px;
        align-items:center;
        gap: 10px;
        margin-top: 6px;
      }
      .carousel-btn{
        width: 36px; height: 36px;
        border-radius: 10px;
        border: 1px solid rgba(0,0,0,.15);
        background: #fff;
        cursor: pointer;
        font-size: 20px;
        line-height: 1;
      }
      @media (max-width: 640px){
        .carousel-controls{ grid-template-columns: 1fr; }
        .carousel-btn{ display:none; } /* 모바일은 스와이프 중심 */
      }

      .album-empty, .album-empty-wide{
        padding: 14px 0;
        color: rgba(0,0,0,.6);
      }
    `;
    document.head.appendChild(style);
  })();

  // ===== helpers =====
  // ===== GitHub Raw (이미지 CDN처럼 사용) 설정 =====
const GH_OWNER  = "crchoi0305";
const GH_REPO   = "SFPL";
const GH_BRANCH = "main";
const GH_RAW_BASE = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}`;

  const grid = document.getElementById("photoGrid");

  function el(tag, cls, html) {
    const n = document.createElement(tag);
    if (cls) n.className = cls;
    if (html !== undefined) n.innerHTML = html;
    return n;
  }

  function isHttpUrl(p) {
    return /^https?:\/\//i.test(String(p));
  }

function normalizeImgSrc(v) {
  if (!v) return "";

  const src =
    (typeof v === "string") ? v :
    (v && typeof v === "object" ? (v.image || v.src || "") : "");

  const s = String(src).trim();
  if (!s) return "";

  if (isHttpUrl(s)) return s;

  let clean = s
    .replace(/^\.?\//, "")   // "./" 제거
    .replace(/^\/+/, "");    // "/" 제거

  // ✅ 핵심: 실제 업로드 저장 위치가 content/assets/photos 이므로 자동 보정
  if (clean.startsWith("assets/photos/")) {
    clean = "content/" + clean;  // => content/assets/photos/...
  }

  return `${GH_RAW_BASE}/${clean}`;
}




  function scrollToIndex(track, i){
    const slides = track.querySelectorAll(".carousel-slide");
    const idx = Math.max(0, Math.min(slides.length - 1, i));
    const target = slides[idx];
    const left = target.offsetLeft - track.offsetLeft;
    track.scrollTo({ left, behavior: "smooth" });
    track.dataset.index = String(idx);
  }

  function setActiveDot(dots, idx){
    [...dots.children].forEach((d, k) => d.classList.toggle("active", k === idx));
  }

  function bindScrollSync(track, dots){
    let raf = null;
    const slides = () => [...track.querySelectorAll(".carousel-slide")];

    track.addEventListener("scroll", () => {
      if (raf) cancelAnimationFrame(raf);
      raf = requestAnimationFrame(() => {
        const ss = slides();
        if (!ss.length) return;

        const center = track.scrollLeft + track.clientWidth / 2;
        let bestIdx = 0;
        let bestDist = Infinity;

        ss.forEach((s, i) => {
          const sCenter = (s.offsetLeft - track.offsetLeft) + s.clientWidth / 2;
          const dist = Math.abs(center - sCenter);
          if (dist < bestDist) { bestDist = dist; bestIdx = i; }
        });

        track.dataset.index = String(bestIdx);
        setActiveDot(dots, bestIdx);
      });
    }, { passive: true });
  }

  // ===== build album carousel =====
  function buildCarousel(album) {
    const card = el("article", "album-card");

    const title = el("h2", "album-title");
    title.textContent = album.title || "Untitled";
    card.appendChild(title);

    const wrap = el("div", "carousel");
    const track = el("div", "carousel-track");
    track.dataset.index = "0";

    // ✅ 핵심: src 경로 보정
    const raw = Array.isArray(album.images) ? album.images : [];
    const imgs = raw.map(normalizeImgSrc).filter(Boolean);

    imgs.forEach((src, i) => {
      const slide = el("div", "carousel-slide");
      const img = document.createElement("img");
      img.className = "carousel-img";
      img.src = src;
      img.alt = `${album.title || "Album"} - ${i + 1}`;
      img.loading = "lazy";
      slide.appendChild(img);
      track.appendChild(slide);
    });

    wrap.appendChild(track);
    card.appendChild(wrap);

    if (!imgs.length) {
      card.appendChild(el("div", "album-empty", "등록된 사진이 없습니다."));
      return card;
    }

    // dots
    const dots = el("div", "carousel-dots");
    imgs.forEach((_, i) => {
      const d = el("button", "dot" + (i === 0 ? " active" : ""), "");
      d.type = "button";
      d.addEventListener("click", () => scrollToIndex(track, i));
      dots.appendChild(d);
    });

    // controls (desktop arrows + dots)
    const controls = el("div", "carousel-controls");
    const prev = el("button", "carousel-btn", "‹");
    const next = el("button", "carousel-btn", "›");
    prev.type = next.type = "button";

    prev.addEventListener("click", () => {
      const cur = parseInt(track.dataset.index || "0", 10);
      scrollToIndex(track, cur - 1);
    });
    next.addEventListener("click", () => {
      const cur = parseInt(track.dataset.index || "0", 10);
      scrollToIndex(track, cur + 1);
    });

    controls.appendChild(prev);
    controls.appendChild(dots);
    controls.appendChild(next);
    card.appendChild(controls);

    // sync dots with scroll (mobile swipe 포함)
    bindScrollSync(track, dots);

    return card;
  }

  // ===== init =====
  async function init() {
    try {
      // ✅ cache-bust
      const res = await fetch(basePrefix + "content/photos.json?v=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error("photos.json load failed");

      const data = await res.json();
      const albums = Array.isArray(data.albums) ? data.albums : [];

      if (!albums.length) {
        grid.appendChild(el("div", "album-empty-wide", "등록된 앨범이 없습니다."));
        return;
      }

      albums.forEach(a => grid.appendChild(buildCarousel(a)));
    } catch (e) {
      console.error(e);
      grid.appendChild(el("div", "album-empty-wide", "Photo 데이터를 불러오지 못했습니다. (content/photos.json 확인)"));
    }
  }

  init();
</script>


</body>
</html>
