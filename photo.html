<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photo | SFPL</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="page-flex">
  <div id="site-header"></div>

  <main class="page-wrap photo-wrap">
    <div class="photo-container">
      <h1 class="page-title">Photos</h1>
      <section id="photoGrid" class="photo-grid"></section>
    </div>
  </main>

  <div id="site-footer"></div>

  <script>
  /**
   * [추가 성능 최적화 전략]
   * 1. CDN 너비 최적화: 800px -> 600px로 조정하여 전송 용량 최소화
   * 2. Intersection Observer: 앨범 카드가 뷰포트에 들어올 때만 이미지 로드 시작
   * 3. 앨범 내 이미지 순차 로딩: 첫 번째 이미지만 즉시 로드, 나머지는 지연 처리
   */

  const basePrefix = (() => {
    const parts = location.pathname.split("/").filter(Boolean);
    if (location.hostname.endsWith("github.io")) {
      const repo = parts[0] || "";
      return "/" + repo + "/";
    }
    return "/";
  })();

  const loadLayout = (id, file, cb) => {
    fetch(basePrefix + file)
      .then(res => res.text())
      .then(html => {
        document.getElementById(id).innerHTML = html;
        if(cb) cb();
      }).catch(console.error);
  };

  loadLayout("site-header", "header.html", () => {
    const btn = document.querySelector(".nav-toggle");
    const mobileNav = document.getElementById("mobileNav");
    if (btn && mobileNav) {
      btn.addEventListener("click", () => {
        const open = mobileNav.classList.toggle("open");
        btn.setAttribute("aria-expanded", String(open));
      });
    }
  });

  loadLayout("site-footer", "footer.html", () => {
    const y = document.getElementById("year");
    if (y) y.textContent = new Date().getFullYear();
  });

  (function injectCSS(){
    if (document.getElementById("photoCarouselCSS")) return;
    const style = document.createElement("style");
    style.id = "photoCarouselCSS";
    style.textContent = `
      main.page-wrap { margin-top: 5px !important; }
      .photo-grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 26px; align-items: start; }
      @media (max-width: 820px){ .photo-grid{ grid-template-columns: 1fr; gap: 18px; } }
      .album-card{ border: 1px solid rgba(0,0,0,.08); border-radius: 16px; padding: 16px; background: #fff; margin-bottom:10px; opacity: 0; transform: translateY(20px); transition: all 0.5s ease; }
      .album-card.visible { opacity: 1; transform: translateY(0); }
      .album-title{ margin: 0 0 12px; font-size: 24px; letter-spacing: -0.02em; }
      .album-date{ font-size: 13px; color: rgba(0,0,0,.55); margin-bottom: 6px; }
      .carousel{ position: relative; width: 100%; overflow: hidden; border-radius: 14px; background: #f5f5f5; }
      .carousel-track{ display:flex; overflow-x:auto; scroll-snap-type: x mandatory; gap: 12px; padding: 0; scrollbar-width: none; }
      .carousel-track::-webkit-scrollbar{ display:none; }
      .carousel-slide{ flex: 0 0 100%; scroll-snap-align: center; display: flex; align-items: center; justify-content: center; min-height: 250px; }
      .carousel-img{ width:100%; height:auto; display:block; object-fit: cover; aspect-ratio: 4/3; transition: opacity 0.3s ease; opacity: 0; }
      .carousel-img.loaded { opacity: 1; }
      .carousel-dots{ display:flex; justify-content:center; gap: 8px; padding: 10px 0 2px; }
      .dot{ width: 7px; height: 7px; border-radius: 999px; background: rgba(0,0,0,.15); border: 0; cursor: pointer; transition: background 0.2s; }
      .dot.active{ background: rgba(0,0,0,.6); width: 15px; }
      .carousel-controls{ display:grid; grid-template-columns: 36px 1fr 36px; align-items:center; gap: 10px; margin-top: 6px; }
      .carousel-btn{ width: 36px; height: 36px; border-radius: 10px; border: 1px solid rgba(0,0,0,.1); background: #fff; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
      @media (max-width: 640px){ .carousel-btn{ display:none; } .carousel-controls{ grid-template-columns: 1fr; } }
      .album-empty-wide{ padding: 40px; text-align:center; color: #888; grid-column: 1 / -1; }
    `;
    document.head.appendChild(style);
  })();

  const GH_OWNER = "crchoi0305";
  const GH_REPO = "SFPL";
  const GH_BRANCH = "main";
  const GH_RAW_BASE = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}`;

  // 최적화된 URL 생성 (너비를 600px로 줄여 더 가볍게 로드)
  function getOptimizedUrl(url) {
    if (!url || url.startsWith('http')) return url;
    return `${url}?nf_resize=fit&w=600&q=70`;
  }

  function resolveImgSources(v) {
    if (!v) return null;
    let src = (typeof v === "string") ? v : (v.image || v.src || "");
    src = src.trim();
    if (!src) return null;

    if (/^https?:\/\//i.test(src) && !src.startsWith(GH_RAW_BASE)) {
      return { primary: src, fallback: "" };
    }

    let rel = src.replace(GH_RAW_BASE + "/", "").replace(/^\/+/, "").replace(/^content\/content\//, "content/");
    const localPath = (basePrefix + rel).replace(/\/\/+/, "/");
    return { 
      primary: getOptimizedUrl(localPath), 
      fallback: `${GH_RAW_BASE}/${rel}` 
    };
  }

  // 앨범 카드가 화면에 보일 때 실행될 옵저버 설정
  const albumObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
        loadAlbumImages(entry.target);
        albumObserver.unobserve(entry.target);
      }
    });
  }, { threshold: 0.1 });

  function loadAlbumImages(card) {
    const images = card.querySelectorAll('.carousel-img[data-src]');
    images.forEach(img => {
      img.src = img.dataset.src;
      img.onload = () => img.classList.add('loaded');
      img.onerror = () => {
        const fallback = img.dataset.fallback;
        if (fallback && img.src !== fallback) img.src = fallback;
      };
      img.removeAttribute('data-src');
    });
  }

  function buildCarousel(album) {
    const card = document.createElement("article");
    card.className = "album-card";
    
    const images = (album.images || []).map(resolveImgSources).filter(Boolean);
    
    let slidesHtml = '';
    let dotsHtml = '';

    if (images.length === 0) {
      slidesHtml = '<div class="album-empty-wide">사진이 없습니다.</div>';
    } else {
      images.forEach((srcs, i) => {
        // 실제 src 대신 data-src를 사용하여 Intersection Observer가 작동할 때 로드함
        slidesHtml += `
          <div class="carousel-slide">
            <img class="carousel-img" data-src="${srcs.primary}" data-fallback="${srcs.fallback}" alt="${album.title} ${i+1}">
          </div>`;
        dotsHtml += `<button class="dot ${i === 0 ? 'active' : ''}" type="button"></button>`;
      });
    }

    card.innerHTML = `
      <div class="album-date">${album.date || ''}</div>
      <h2 class="album-title">${album.title || 'Untitled'}</h2>
      <div class="carousel">
        <div class="carousel-track" data-index="0">${slidesHtml}</div>
      </div>
      <div class="carousel-controls" ${images.length <= 1 ? 'style="display:none"' : ''}>
        <button class="carousel-btn prev" type="button">‹</button>
        <div class="carousel-dots">${dotsHtml}</div>
        <button class="carousel-btn next" type="button">›</button>
      </div>
    `;

    const track = card.querySelector(".carousel-track");
    const dotsContainer = card.querySelector(".carousel-dots");

    if (images.length > 1) {
      card.querySelector(".prev").addEventListener("click", () => move(track, -1, dotsContainer));
      card.querySelector(".next").addEventListener("click", () => move(track, 1, dotsContainer));
      
      const dots = dotsContainer.querySelectorAll(".dot");
      dots.forEach((dot, i) => dot.addEventListener("click", () => scrollToIndex(track, i, dotsContainer)));

      track.addEventListener("scroll", () => {
        clearTimeout(track.st);
        track.st = setTimeout(() => {
          const idx = Math.round(track.scrollLeft / track.clientWidth);
          track.dataset.index = idx;
          updateDots(dotsContainer, idx);
        }, 100);
      }, { passive: true });
    }

    albumObserver.observe(card);
    return card;
  }

  function move(track, dir, dots) {
    const cur = parseInt(track.dataset.index || "0");
    scrollToIndex(track, cur + dir, dots);
  }

  function scrollToIndex(track, i, dots) {
    const slides = track.querySelectorAll(".carousel-slide");
    if (i < 0 || i >= slides.length) return;
    track.scrollTo({ left: slides[i].offsetLeft, behavior: 'smooth' });
    track.dataset.index = i;
    updateDots(dots, i);
  }

  function updateDots(dots, idx) {
    dots.querySelectorAll(".dot").forEach((d, i) => d.classList.toggle("active", i === idx));
  }

  async function init() {
    const grid = document.getElementById("photoGrid");
    try {
      const res = await fetch(`${basePrefix}content/photos.json?v=${Date.now()}`);
      const data = await res.json();
      const albums = (data.albums || []).sort((a, b) => {
        return new Date(b.date.replace(/\./g, '-')) - new Date(a.date.replace(/\./g, '-'));
      });

      if (!albums.length) {
        grid.innerHTML = '<div class="album-empty-wide">등록된 앨범이 없습니다.</div>';
        return;
      }

      albums.forEach(album => grid.appendChild(buildCarousel(album)));
    } catch (e) {
      grid.innerHTML = '<div class="album-empty-wide">데이터 로드 실패</div>';
    }
  }

  init();
  </script>
</body>
</html>