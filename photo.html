<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photo | SFPL</title>
  <link rel="stylesheet" href="../styles.css" />
</head>

<body class="page-flex">

  <!-- ✅ 공통 헤더 삽입 위치 -->
  <div id="site-header"></div>

  <main class="page-wrap">
    <div class="container">
      <h1 class="page-title">Photos</h1>
      <p class="page-desc">
        행사/연구실 활동 사진을 앨범(캐러셀) 형태로 표시합니다.
        (데이터: <code>content/photos.json</code>)
      </p>

      <section id="photoGrid" class="photo-grid" aria-label="Photo albums">
        <!-- JS render -->
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <div><strong>친환경/기능성 고분자 연구실</strong></div>
      <div>© <span id="year"></span></div>
    </div>
  </footer>

  <script>
    /* =========================
       footer year
    ========================= */
    const y = document.getElementById("year");
    if (y) y.textContent = new Date().getFullYear();

    /* =========================
       header load (photo.html은 상위 폴더에 header.html)
    ========================= */
    fetch("../header.html")
      .then(res => {
        if (!res.ok) throw new Error("header.html load failed");
        return res.text();
      })
      .then(html => {
        document.getElementById("site-header").innerHTML = html;

        // hamburger toggle
        const btn = document.querySelector(".nav-toggle");
        const mobileNav = document.getElementById("mobileNav");
        if (btn && mobileNav) {
          btn.addEventListener("click", () => {
            const open = mobileNav.classList.toggle("open");
            btn.setAttribute("aria-expanded", String(open));
          });
        }

        // prevent jump for dropdown parents
        document
          .querySelectorAll(".dropdown-toggle, .mobile-nav .m-link[href='#']")
          .forEach(el => el.addEventListener("click", e => e.preventDefault()));

        // mobile submenu toggle
        document
          .querySelectorAll("#mobileNav [data-toggle='sub']")
          .forEach(t => {
            t.addEventListener("click", e => {
              e.preventDefault();
              const sub = t.nextElementSibling;
              if (sub && sub.classList.contains("m-sub")) {
                sub.classList.toggle("open");
              }
            });
          });
      })
      .catch(err => console.error(err));

    /* =========================
       Photo render
    ========================= */
    const grid = document.getElementById("photoGrid");

    function el(tag, cls, html) {
      const n = document.createElement(tag);
      if (cls) n.className = cls;
      if (html !== undefined) n.innerHTML = html;
      return n;
    }

    function buildCarousel(album) {
      const card = el("article", "album-card");

      const title = el("h2", "album-title");
      title.textContent = album.title || "Untitled";
      card.appendChild(title);

      const wrap = el("div", "carousel");
      const track = el("div", "carousel-track");
      track.dataset.index = "0";

      const imgs = Array.isArray(album.images) ? album.images : [];
      imgs.forEach((src, i) => {
        const slide = el("div", "carousel-slide");
        const img = document.createElement("img");
        img.className = "carousel-img";
        img.src = src;
        img.alt = `${album.title || "Album"} - ${i + 1}`;
        img.loading = "lazy";
        slide.appendChild(img);
        track.appendChild(slide);
      });

      wrap.appendChild(track);

      const controls = el("div", "carousel-controls");
      const prev = el("button", "carousel-btn", "‹");
      const next = el("button", "carousel-btn", "›");
      prev.type = next.type = "button";

      const dots = el("div", "carousel-dots");
      imgs.forEach((_, i) => {
        const d = el("button", "dot" + (i === 0 ? " active" : ""), "");
        d.type = "button";
        d.addEventListener("click", () => setIndex(track, dots, i));
        dots.appendChild(d);
      });

      prev.addEventListener("click", () => step(track, dots, -1));
      next.addEventListener("click", () => step(track, dots, +1));

      controls.appendChild(prev);
      controls.appendChild(dots);
      controls.appendChild(next);

      card.appendChild(wrap);
      card.appendChild(controls);

      if (!imgs.length) {
        card.appendChild(el("div", "album-empty", "등록된 사진이 없습니다."));
      } else {
        let startX = null;
        track.addEventListener("touchstart", e => startX = e.touches[0].clientX, { passive: true });
        track.addEventListener("touchend", e => {
          if (startX === null) return;
          const dx = e.changedTouches[0].clientX - startX;
          startX = null;
          if (Math.abs(dx) > 40) step(track, dots, dx < 0 ? 1 : -1);
        }, { passive: true });
      }

      return card;
    }

    function setIndex(track, dots, i) {
      const slides = track.children.length;
      const next = Math.max(0, Math.min(slides - 1, i));
      track.style.transform = `translateX(${-next * 100}%)`;
      track.dataset.index = String(next);
      [...dots.children].forEach((d, k) => d.classList.toggle("active", k === next));
    }

    function step(track, dots, dir) {
      const cur = parseInt(track.dataset.index || "0", 10);
      setIndex(track, dots, cur + dir);
    }

    async function init() {
      try {
        const res = await fetch("../content/photos.json", { cache: "no-store" });
        if (!res.ok) throw new Error("photos.json load failed");
        const data = await res.json();
        const albums = Array.isArray(data.albums) ? data.albums : [];

        if (!albums.length) {
          grid.appendChild(el("div", "album-empty-wide", "등록된 앨범이 없습니다."));
          return;
        }

        albums.forEach(a => grid.appendChild(buildCarousel(a)));
      } catch (e) {
        console.error(e);
        grid.appendChild(el("div", "album-empty-wide", "Photo 데이터를 불러오지 못했습니다. (content/photos.json 확인)"));
      }
    }

    init();
  </script>

</body>
</html>
