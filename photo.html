<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photo | SFPL</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="page-flex">
  <div id="site-header"></div>

  <main class="page-wrap photo-wrap">
    <div class="photo-container">
      <h1 class="page-title">Photos</h1>
      <section id="photoGrid" class="photo-grid"></section>
    </div>
  </main>

  <div id="site-footer"></div>

  <script>
  /**
   * [오류 수정 및 성능 개선 사항]
   * 1. URL 파싱 오류 해결: location.origin을 결합하여 fetch 경로를 절대 주소로 보장
   * 2. 경로 정규화: 중복 슬래시 및 빈 경로 방어 로직 강화
   * 3. 모바일 로딩 보장: Intersection Observer가 감지되지 않는 환경을 위한 즉시 로딩 폴백
   */

  const basePrefix = (() => {
    const host = window.location.hostname;
    const path = window.location.pathname;
    const parts = path.split("/").filter(Boolean);
    
    if (host.endsWith("github.io")) {
      const repo = parts[0] || "";
      return "/" + repo + "/";
    }
    return "/";
  })();

  // 절대 경로를 생성하는 유틸리티
  const getFullUrl = (relativeFile) => {
    const cleanPath = (basePrefix + relativeFile).replace(/\/+/g, "/");
    return window.location.origin + cleanPath;
  };

  const loadLayout = (id, file, cb) => {
    const url = getFullUrl(file);
    fetch(url)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.text();
      })
      .then(html => {
        const target = document.getElementById(id);
        if (target) {
          target.innerHTML = html;
          if(cb) cb();
        }
      })
      .catch(err => {
        console.error(`Failed to load ${file}:`, err);
      });
  };

  // 레이아웃 로드 시작
  loadLayout("site-header", "header.html", () => {
    const btn = document.querySelector(".nav-toggle");
    const mobileNav = document.getElementById("mobileNav");
    if (btn && mobileNav) {
      btn.addEventListener("click", () => {
        const open = mobileNav.classList.toggle("open");
        btn.setAttribute("aria-expanded", String(open));
      });
    }
  });

  loadLayout("site-footer", "footer.html", () => {
    const y = document.getElementById("year");
    if (y) y.textContent = new Date().getFullYear();
  });

  (function injectCSS(){
    if (document.getElementById("photoCarouselCSS")) return;
    const style = document.createElement("style");
    style.id = "photoCarouselCSS";
    style.textContent = `
      main.page-wrap { margin-top: 5px !important; }
      .photo-grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 26px; align-items: start; }
      @media (max-width: 820px){ .photo-grid{ grid-template-columns: 1fr; gap: 18px; } }
      .album-card{ border: 1px solid rgba(0,0,0,.08); border-radius: 16px; padding: 16px; background: #fff; margin-bottom:10px; opacity: 0; transform: translateY(10px); transition: opacity 0.4s ease, transform 0.4s ease; }
      .album-card.visible { opacity: 1; transform: translateY(0); }
      .album-title{ margin: 0 0 12px; font-size: 24px; letter-spacing: -0.02em; }
      .album-date{ font-size: 13px; color: rgba(0,0,0,.55); margin-bottom: 6px; }
      .carousel{ position: relative; width: 100%; overflow: hidden; border-radius: 14px; background: #eee; }
      .carousel-track{ display:flex; overflow-x:auto; scroll-snap-type: x mandatory; gap: 0; padding: 0; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
      .carousel-track::-webkit-scrollbar{ display:none; }
      .carousel-slide{ flex: 0 0 100%; scroll-snap-align: center; display: flex; align-items: center; justify-content: center; min-height: 200px; aspect-ratio: 4/3; background: #f7f7f7; }
      .carousel-img{ width:100%; height:100%; display:block; object-fit: cover; transition: opacity 0.4s ease; opacity: 0; }
      .carousel-img.loaded { opacity: 1; }
      .carousel-dots{ display:flex; justify-content:center; gap: 6px; padding: 12px 0 4px; }
      .dot{ width: 6px; height: 6px; border-radius: 50%; background: rgba(0,0,0,.1); border: 0; cursor: pointer; padding: 0; transition: all 0.2s; }
      .dot.active{ background: rgba(0,0,0,.5); transform: scale(1.3); }
      .carousel-controls{ display:grid; grid-template-columns: 36px 1fr 36px; align-items:center; gap: 10px; margin-top: 4px; }
      .carousel-btn{ width: 36px; height: 36px; border-radius: 10px; border: 1px solid rgba(0,0,0,.08); background: #fff; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; color: #555; }
      @media (max-width: 640px){ .carousel-btn{ display:none; } .carousel-controls{ grid-template-columns: 1fr; } }
      .album-empty-wide{ padding: 40px; text-align:center; color: #999; grid-column: 1 / -1; }
    `;
    document.head.appendChild(style);
  })();

  const GH_OWNER = "crchoi0305";
  const GH_REPO = "SFPL";
  const GH_BRANCH = "main";
  const GH_RAW_BASE = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}`;

  // 최적화 파라미터 적용 (품질과 크기를 더 압축하여 속도 개선)
  function getOptimizedUrl(url) {
    if (!url || url.startsWith('http')) return url;
    return `${url}?nf_resize=fit&w=480&q=50`;
  }

  function resolveImgSources(v) {
    if (!v) return null;
    let src = (typeof v === "string") ? v : (v.image || v.src || "");
    src = src.trim();
    if (!src) return null;

    if (/^https?:\/\//i.test(src) && !src.startsWith(GH_RAW_BASE)) {
      return { primary: src, fallback: "" };
    }

    let rel = src.replace(GH_RAW_BASE + "/", "").replace(/^\/+/, "").replace(/^content\/content\//, "content/");
    const localPath = (basePrefix + rel).replace(/\/+/g, "/");
    return { 
      primary: getOptimizedUrl(localPath), 
      fallback: `${GH_RAW_BASE}/${rel}` 
    };
  }

  const albumObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting || entry.boundingClientRect.top < window.innerHeight) {
        entry.target.classList.add('visible');
        loadAlbumImages(entry.target);
        albumObserver.unobserve(entry.target);
      }
    });
  }, { rootMargin: '200px' }); // 화면 진입 200px 전부터 미리 로딩 시작

  function loadAlbumImages(card) {
    const images = card.querySelectorAll('.carousel-img[data-src]');
    images.forEach(img => {
      const p = img.getAttribute('data-src');
      const f = img.getAttribute('data-fallback');
      img.src = p;
      img.onload = () => img.classList.add('loaded');
      img.onerror = () => {
        if (f && img.src !== f) {
          img.src = f;
          img.classList.add('loaded');
        }
      };
      img.removeAttribute('data-src');
    });
  }

  function buildCarousel(album) {
    const card = document.createElement("article");
    card.className = "album-card";
    
    const images = (album.images || []).map(resolveImgSources).filter(Boolean);
    let slidesHtml = '';
    let dotsHtml = '';

    if (images.length === 0) {
      slidesHtml = '<div class="album-empty-wide">이미지가 없습니다.</div>';
    } else {
      images.forEach((srcs, i) => {
        slidesHtml += `
          <div class="carousel-slide">
            <img class="carousel-img" data-src="${srcs.primary}" data-fallback="${srcs.fallback}" alt="${album.title} ${i+1}">
          </div>`;
        dotsHtml += `<button class="dot ${i === 0 ? 'active' : ''}" type="button"></button>`;
      });
    }

    card.innerHTML = `
      <div class="album-date">${album.date || ''}</div>
      <h2 class="album-title">${album.title || 'Untitled'}</h2>
      <div class="carousel">
        <div class="carousel-track" data-index="0">${slidesHtml}</div>
      </div>
      <div class="carousel-controls" ${images.length <= 1 ? 'style="display:none"' : ''}>
        <button class="carousel-btn prev" type="button">‹</button>
        <div class="carousel-dots">${dotsHtml}</div>
        <button class="carousel-btn next" type="button">›</button>
      </div>
    `;

    const track = card.querySelector(".carousel-track");
    const dotsContainer = card.querySelector(".carousel-dots");

    if (images.length > 1) {
      card.querySelector(".prev").addEventListener("click", () => move(track, -1, dotsContainer));
      card.querySelector(".next").addEventListener("click", () => move(track, 1, dotsContainer));
      
      const dots = dotsContainer.querySelectorAll(".dot");
      dots.forEach((dot, i) => dot.addEventListener("click", () => scrollToIndex(track, i, dotsContainer)));

      track.addEventListener("scroll", () => {
        clearTimeout(track.st);
        track.st = setTimeout(() => {
          const idx = Math.round(track.scrollLeft / (track.offsetWidth || 1));
          track.dataset.index = idx;
          updateDots(dotsContainer, idx);
        }, 50);
      }, { passive: true });
    }

    albumObserver.observe(card);
    return card;
  }

  function move(track, dir, dots) {
    const cur = parseInt(track.dataset.index || "0");
    scrollToIndex(track, cur + dir, dots);
  }

  function scrollToIndex(track, i, dots) {
    const slides = track.querySelectorAll(".carousel-slide");
    if (i < 0 || i >= slides.length) return;
    track.scrollTo({ left: slides[i].offsetLeft, behavior: 'smooth' });
    track.dataset.index = i;
    updateDots(dots, i);
  }

  function updateDots(dots, idx) {
    const all = dots.querySelectorAll(".dot");
    all.forEach((d, i) => d.classList.toggle("active", i === idx));
  }

  async function init() {
    const grid = document.getElementById("photoGrid");
    try {
      const url = getFullUrl("content/photos.json?v=" + Date.now());
      const res = await fetch(url);
      const data = await res.json();
      const albums = (data.albums || []).sort((a, b) => {
        return new Date(b.date.replace(/\./g, '-')) - new Date(a.date.replace(/\./g, '-'));
      });

      if (!albums.length) {
        grid.innerHTML = '<div class="album-empty-wide">등록된 사진이 없습니다.</div>';
        return;
      }

      albums.forEach(album => grid.appendChild(buildCarousel(album)));
    } catch (e) {
      grid.innerHTML = '<div class="album-empty-wide">데이터 로딩 실패</div>';
    }
  }

  init();
  </script>
</body>
</html>