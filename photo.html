<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Photo | SFPL</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="page-flex">
  <div id="site-header"></div>

  <main class="page-wrap photo-wrap">
    <div class="photo-container">
      <h1 class="page-title">Photos</h1>
      <section id="photoGrid" class="photo-grid"></section>
    </div>
  </main>

  <div id="site-footer"></div>

  <script>
  /**
   * [성능 개선 포인트]
   * 1. Netlify Image CDN을 사용하여 이미지 크기를 줄이고 차세대 포맷(WebP)을 제공합니다.
   * 2. loading="lazy"와 이미지 최적화를 결합하여 초기 로딩 속도를 대폭 향상합니다.
   */

  const basePrefix = (() => {
    const parts = location.pathname.split("/").filter(Boolean);
    if (location.hostname.endsWith("github.io")) {
      const repo = parts[0] || "";
      return "/" + repo + "/";
    }
    return "/";
  })();

  // Header/Footer Load (기존 로직 유지)
  const loadLayout = (id, file, cb) => {
    fetch(basePrefix + file)
      .then(res => res.text())
      .then(html => {
        document.getElementById(id).innerHTML = html;
        if(cb) cb();
      }).catch(console.error);
  };

  loadLayout("site-header", "header.html", () => {
    const btn = document.querySelector(".nav-toggle");
    const mobileNav = document.getElementById("mobileNav");
    if (btn && mobileNav) {
      btn.addEventListener("click", () => {
        const open = mobileNav.classList.toggle("open");
        btn.setAttribute("aria-expanded", String(open));
      });
    }
  });

  loadLayout("site-footer", "footer.html", () => {
    const y = document.getElementById("year");
    if (y) y.textContent = new Date().getFullYear();
  });

  // CSS (기존 유지)
  (function injectCSS(){
    if (document.getElementById("photoCarouselCSS")) return;
    const style = document.createElement("style");
    style.id = "photoCarouselCSS";
    style.textContent = `
      main.page-wrap { margin-top: 5px !important; }
      .photo-grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 26px; align-items: start; }
      @media (max-width: 820px){ .photo-grid{ grid-template-columns: 1fr; gap: 18px; } }
      .album-card{ border: 1px solid rgba(0,0,0,.08); border-radius: 16px; padding: 16px; background: #fff; margin-bottom:10px; }
      .album-title{ margin: 0 0 12px; font-size: 24px; letter-spacing: -0.02em; }
      .album-date{ font-size: 13px; color: rgba(0,0,0,.55); margin-bottom: 6px; }
      .carousel{ position: relative; width: 100%; overflow: hidden; }
      .carousel-track{ display:flex; overflow-x:auto; scroll-snap-type: x mandatory; gap: 12px; padding: 6px 2px 4px; scrollbar-width: none; }
      .carousel-track::-webkit-scrollbar{ display:none; }
      .carousel-slide{ flex: 0 0 100%; scroll-snap-align: center; }
      .carousel-img{ width:100%; height:auto; display:block; border-radius: 14px; object-fit: cover; aspect-ratio: 4/3; background: #f0f0f0; }
      .carousel-dots{ display:flex; justify-content:center; gap: 8px; padding: 10px 0 2px; }
      .dot{ width: 7px; height: 7px; border-radius: 999px; background: rgba(0,0,0,.25); border: 0; cursor: pointer; }
      .dot.active{ background: rgba(0,0,0,.75); }
      .carousel-controls{ display:grid; grid-template-columns: 36px 1fr 36px; align-items:center; gap: 10px; margin-top: 6px; }
      .carousel-btn{ width: 36px; height: 36px; border-radius: 10px; border: 1px solid rgba(0,0,0,.15); background: #fff; cursor: pointer; }
      @media (max-width: 640px){ .carousel-btn{ display:none; } .carousel-controls{ grid-template-columns: 1fr; } }
      .album-empty-wide{ padding: 40px; text-align:center; color: #888; grid-column: 1 / -1; }
    `;
    document.head.appendChild(style);
  })();

  const GH_OWNER = "crchoi0305";
  const GH_REPO = "SFPL";
  const GH_BRANCH = "main";
  const GH_RAW_BASE = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}`;

  // ✅ [핵심 함수] Netlify Image CDN 파라미터 추가
  // width=800: 너비를 800px로 제한 (품질 대비 용량 최적점)
  // quality=75: 압축률 설정
  // format=webp: 지원 브라우저에서 자동으로 고효율 포맷 사용
  function getOptimizedUrl(url) {
    if (!url || url.startsWith('http')) return url; // 외부 링크는 처리 제외
    // Netlify 환경에서 작동하는 쿼리 방식
    return `${url}?nf_resize=fit&w=800`;
  }

  function resolveImgSources(v) {
    if (!v) return null;
    let src = (typeof v === "string") ? v : (v.image || v.src || "");
    src = src.trim();
    if (!src) return null;

    if (/^https?:\/\//i.test(src) && !src.startsWith(GH_RAW_BASE)) {
      return { primary: src, fallback: "" };
    }

    let rel = src.replace(GH_RAW_BASE + "/", "").replace(/^\/+/, "").replace(/^content\/content\//, "content/");
    
    // Netlify 배포 환경인 경우 최적화 URL 적용
    const localPath = (basePrefix + rel).replace(/\/\/+/, "/");
    const primary = getOptimizedUrl(localPath);
    const fallback = `${GH_RAW_BASE}/${rel}`;

    return { primary, fallback };
  }

  function setImgWithFallback(img, sources) {
    if (!img || !sources) return;
    img.src = sources.primary;
    img.onerror = () => {
      if (sources.fallback && img.src !== sources.fallback) {
        img.src = sources.fallback; // CDN 실패 시 원본 fallback
      }
    };
  }

  // Carousel Logic (기존 유지하되 최적화 적용)
  function buildCarousel(album) {
    const card = document.createElement("article");
    card.className = "album-card";
    
    const html = `
      <div class="album-date">${album.date || ''}</div>
      <h2 class="album-title">${album.title || 'Untitled'}</h2>
      <div class="carousel">
        <div class="carousel-track" data-index="0"></div>
      </div>
      <div class="carousel-controls">
        <button class="carousel-btn prev" type="button">‹</button>
        <div class="carousel-dots"></div>
        <button class="carousel-btn next" type="button">›</button>
      </div>
    `;
    card.innerHTML = html;

    const track = card.querySelector(".carousel-track");
    const dotsContainer = card.querySelector(".carousel-dots");
    const images = (album.images || []).map(resolveImgSources).filter(Boolean);

    if (images.length === 0) {
      track.innerHTML = '<div class="album-empty-wide">사진이 없습니다.</div>';
      card.querySelector(".carousel-controls").style.display = 'none';
      return card;
    }

    images.forEach((srcs, i) => {
      const slide = document.createElement("div");
      slide.className = "carousel-slide";
      const img = document.createElement("img");
      img.className = "carousel-img";
      img.loading = "lazy"; // 지연 로딩 활성화
      setImgWithFallback(img, srcs);
      slide.appendChild(img);
      track.appendChild(slide);

      const dot = document.createElement("button");
      dot.className = `dot ${i === 0 ? 'active' : ''}`;
      dot.addEventListener("click", () => scrollToIndex(track, i, dotsContainer));
      dotsContainer.appendChild(dot);
    });

    card.querySelector(".prev").addEventListener("click", () => {
      const idx = parseInt(track.dataset.index) - 1;
      scrollToIndex(track, idx, dotsContainer);
    });
    card.querySelector(".next").addEventListener("click", () => {
      const idx = parseInt(track.dataset.index) + 1;
      scrollToIndex(track, idx, dotsContainer);
    });

    track.addEventListener("scroll", () => {
      clearTimeout(track.st);
      track.st = setTimeout(() => syncDots(track, dotsContainer), 100);
    }, { passive: true });

    return card;
  }

  function scrollToIndex(track, i, dots) {
    const slides = track.querySelectorAll(".carousel-slide");
    if (i < 0 || i >= slides.length) return;
    track.scrollTo({ left: slides[i].offsetLeft - track.offsetLeft, behavior: 'smooth' });
    track.dataset.index = i;
    updateDots(dots, i);
  }

  function syncDots(track, dots) {
    const idx = Math.round(track.scrollLeft / track.clientWidth);
    track.dataset.index = idx;
    updateDots(dots, idx);
  }

  function updateDots(dots, idx) {
    const ds = dots.querySelectorAll(".dot");
    ds.forEach((d, i) => d.classList.toggle("active", i === idx));
  }

  async function init() {
    const grid = document.getElementById("photoGrid");
    try {
      const res = await fetch(`${basePrefix}content/photos.json?v=${Date.now()}`);
      const data = await res.json();
      const albums = (data.albums || []).sort((a, b) => {
        return new Date(b.date.replace(/\./g, '-')) - new Date(a.date.replace(/\./g, '-'));
      });

      if (!albums.length) {
        grid.innerHTML = '<div class="album-empty-wide">등록된 앨범이 없습니다.</div>';
        return;
      }

      albums.forEach(album => grid.appendChild(buildCarousel(album)));
    } catch (e) {
      grid.innerHTML = '<div class="album-empty-wide">데이터 로드 실패</div>';
    }
  }

  init();
  </script>
</body>
</html>