<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>친환경/기능성 고분자 연구실 | Sustainable/Functional Polymer Lab</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div id="site-header"></div>

  <main class="container hero">
    <section class="hero-frame" aria-label="메인 비주얼">
      <div class="hero-content">
        <h1 class="hero-title">Sustainable/Functional Polymer Lab</h1>
        <p class="hero-subtitle">친환경/기능성 고분자 연구실</p>
        <p class="hero-desc"></p>
      </div>
    </section>

    <section class="page-wrap">
      <div class="card page-hero">
        <div class="home-news">
          <div class="home-news-head">
            <h3 class="home-news-title">Latest News</h3>
            <a class="home-news-more" href="news.html">View all →</a>
          </div>
          <div id="latestNews" class="home-news-list" aria-label="Latest news list">
            <!-- JS render -->
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="site-footer"></div>

<script>
  (function () {
    const hash = window.location.hash || "";
    const hasToken = hash.includes("recovery_token=") || hash.includes("invite_token=");
    if (!hasToken) return;

    const target = "/recovery.html" + hash;
    if ((window.location.pathname + window.location.hash) === target) return;

    if (!sessionStorage.getItem("did_redirect_to_recovery")) {
      sessionStorage.setItem("did_redirect_to_recovery", "1");
      window.location.replace(target);
    }
  })();

  // header load
  fetch("header.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("site-header").innerHTML = html;

      const btn = document.querySelector(".nav-toggle");
      const mobileNav = document.getElementById("mobileNav");

      if (btn && mobileNav) {
        btn.addEventListener("click", () => {
          const open = mobileNav.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(open));
        });
      }

      document
        .querySelectorAll(".dropdown-toggle, .mobile-nav .m-link[href='#']")
        .forEach((el) => el.addEventListener("click", (e) => e.preventDefault()));

      document.querySelectorAll('#mobileNav .m-link[data-toggle="sub"]').forEach((link) => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const sub = link.nextElementSibling;
          if (sub && sub.classList.contains('m-sub')) sub.classList.toggle('open');
        });
      });
    })
    .catch(err => console.error("header load failed:", err));

  // footer load
  fetch("footer.html")
    .then(res => {
      if (!res.ok) throw new Error("footer.html load failed");
      return res.text();
    })
    .then(html => {
      document.getElementById("site-footer").innerHTML = html;
      const y = document.getElementById("year");
      if (y) y.textContent = new Date().getFullYear();
    })
    .catch(err => console.error(err));

  // latest news
  const latestWrap = document.getElementById("latestNews");

  function safeDate(d) {
    if (!d) return 0;
    const s = String(d).trim().replaceAll(".", "-").replaceAll("/", "-");
    const t = Date.parse(s);
    return Number.isFinite(t) ? t : 0;
  }

  function formatDate(d) {
    if (!d) return "";
    const m = String(d).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(m)) return m.replaceAll("-", ".");
    return m;
  }

  function isHttpUrl(p){ return /^https?:\/\//i.test(String(p)); }

  // Netlify Image CDN helper (A안): 원본은 유지하고, 전송되는 이미지만 리사이즈/압축/포맷 변환
  // - 내부 경로(/content/...)는 /.netlify/images 로 감싸서 요청
  // - 외부 URL(http/https)은 그대로 사용
  function nlImg(url, w, q = 70, fm = "webp") {
    if (!url) return "";
    const s = String(url).trim();
    if (!s) return "";
    if (isHttpUrl(s)) return s;
    // "/" 유지 (encodeURIComponent 대신 encodeURI)
    const u = encodeURI(s.startsWith("/") ? s : ("/" + s));
    return `/.netlify/images?url=${u}&w=${w}&q=${q}&fm=${fm}`;
  }

  // ✅ 핵심: 이미지는 항상 content/assets/news 기준으로 읽기
  function normalizeImgSrc(v) {
    if (!v) return "";
    const src = (typeof v === "string") ? v : (v && typeof v === "object" ? (v.src || v.image || "") : "");
    const s = String(src || "").trim();
    if (!s) return "";

    // 외부 URL은 그대로
    if (isHttpUrl(s)) return s;

    // 앞의 ./, / 제거
    let clean = s.replace(/^\.?\//, "").replace(/^\/+/, "");

    // 이미 content/assets/news 로 들어오는 경우
    if (clean.startsWith("content/assets/news/")) return "/" + clean;

    // /assets/news/... 또는 assets/news/...
    clean = clean.replace(/^assets\/news\//, "");
    clean = clean.replace(/^content\/assets\/news\//, "");

    // news/... 로 오는 경우도 제거
    clean = clean.replace(/^news\//, "");

    // 파일명만 남았든, 하위폴더가 있든 최종적으로 content/assets/news 아래로
    return "/content/assets/news/" + clean;
  }

  // CSS auto inject
  (function injectHomeNewsCSS(){
    if (document.getElementById("home-news-carousel-css")) return;
    const css = `
      .home-news-item { cursor: pointer; }
      .home-news-desc{
        color:#555; line-height:1.6; margin-top: 8px; white-space: pre-wrap;
      }

      .home-news-carousel{
        position: relative;
        overflow: hidden;
        border-radius: 14px;
        margin-top: 12px;
        background: rgba(0,0,0,.03);
      }
      .home-news-track{
        display: flex;
        transition: transform .35s ease;
        will-change: transform;
      }
      .home-news-slide{
        min-width: 100%;
        flex-shrink: 0;
        display:flex;
        align-items:center;
        justify-content:center;
      }
      .home-news-slide img{
        width: 100%;
        max-width: 720px;
        height: 220px;
        object-fit: cover;
        display:block;
      }

      .home-news-dots{
        display:flex;
        justify-content:center;
        gap: 6px;
        margin-top: 10px;
      }
      .home-news-dot{
        width: 8px; height: 8px;
        border-radius: 50%;
        background: #d0d0d0;
        border: none;
        padding: 0;
      }
      .home-news-dot.active{ background: #6bbf45; }

      @media (max-width: 640px){
        .home-news-slide img{
          max-width: 100%;
          height: 200px;
        }
      }
    `;
    const style = document.createElement("style");
    style.id = "home-news-carousel-css";
    style.textContent = css;
    document.head.appendChild(style);
  })();

  // ===== 아이폰 디코딩 병목 해결: 첫 장만 로드 + 넘길 때 로드 =====
  function hydrateImg(img){
    if (!img || img.dataset.hydrated === "1") return;

    const src = img.dataset.src || "";
    if (src) img.src = src;

    const srcset = img.dataset.srcset || "";
    if (srcset) img.srcset = srcset;

    const sizes = img.dataset.sizes || "";
    if (sizes) img.sizes = sizes;

    img.dataset.hydrated = "1";
  }

  function hydrateHomeAround(track, idx, radius = 1){
    const slides = [...track.querySelectorAll(".home-news-slide")];
    for (let k = idx - radius; k <= idx + radius; k++){
      if (k < 0 || k >= slides.length) continue;
      const img = slides[k].querySelector("img");
      hydrateImg(img);
    }
  }

  function setHomeIndex(track, dots, i){
    const max = track.children.length;
    const next = Math.max(0, Math.min(max - 1, i));
    track.style.transform = `translateX(${-next * 100}%)`;
    track.dataset.index = String(next);
    [...dots.children].forEach((d, k) => d.classList.toggle("active", k === next));

    // ✅ 현재 슬라이드(+양옆 1장)만 로드
    hydrateHomeAround(track, next, 1);
  }

  function stepHome(track, dots, dir){
    const max = track.children.length;
    if (max <= 1) return;
    const cur = parseInt(track.dataset.index || "0", 10);
    const next = (cur + dir + max) % max;
    setHomeIndex(track, dots, next);
  }

  function renderHomePost(p) {
    const item = document.createElement("article");
    item.className = "home-news-item";

    const top = document.createElement("div");
    top.className = "home-news-top";

    const date = document.createElement("div");
    date.className = "home-news-date";
    date.textContent = formatDate(p.date || "");

    const title = document.createElement("div");
    title.className = "home-news-item-title";
    title.textContent = p.title || "Untitled";

    top.appendChild(date);
    top.appendChild(title);
    item.appendChild(top);

    if (p.desc) {
      const desc = document.createElement("div");
      desc.className = "home-news-desc";
      desc.textContent = p.desc;
      item.appendChild(desc);
    } else {
      const lines = Array.isArray(p.body) ? p.body : (p.body ? [String(p.body)] : []);
      if (lines.length) {
        const desc = document.createElement("div");
        desc.className = "home-news-desc";
        desc.textContent = lines[0];
        item.appendChild(desc);
      }
    }

    const imgsRaw = Array.isArray(p.images) ? p.images : [];
    const imgs = imgsRaw.map(normalizeImgSrc).filter(Boolean);

    if (imgs.length) {
      const carousel = document.createElement("div");
      carousel.className = "home-news-carousel";

      const track = document.createElement("div");
      track.className = "home-news-track";
      track.dataset.index = "0";

      imgs.forEach((src, i) => {
        const slide = document.createElement("div");
        slide.className = "home-news-slide";

        const img = document.createElement("img");

        // ✅ 즉시 src를 넣지 않고 data-*에 저장
        img.dataset.src = nlImg(src, 720);
        img.dataset.srcset = `${nlImg(src, 480)} 480w, ${nlImg(src, 720)} 720w, ${nlImg(src, 960)} 960w`;
        img.dataset.sizes = "(max-width: 640px) 100vw, 720px";

        img.alt = `${p.title || "News"} - ${i + 1}`;
        img.loading = "lazy";
        img.decoding = "async";
        img.width = 720;
        img.height = 220;

        // ✅ 첫 장만 즉시 로드
        if (i === 0) hydrateImg(img);

        slide.appendChild(img);
        track.appendChild(slide);
      });

      carousel.appendChild(track);
      item.appendChild(carousel);

      const dots = document.createElement("div");
      dots.className = "home-news-dots";

      imgs.forEach((_, i) => {
        const d = document.createElement("button");
        d.type = "button";
        d.className = "home-news-dot" + (i === 0 ? " active" : "");
        d.addEventListener("click", (e) => {
          e.stopPropagation();
          setHomeIndex(track, dots, i);
          restartAuto();
        });
        dots.appendChild(d);
      });
      item.appendChild(dots);

      const INTERVAL = 3500;
      let timer = null;

      const startAuto = () => {
        if (imgs.length <= 1) return;
        if (timer) return;
        timer = setInterval(() => stepHome(track, dots, +1), INTERVAL);
      };
      const stopAuto = () => {
        if (!timer) return;
        clearInterval(timer);
        timer = null;
      };
      const restartAuto = () => {
        stopAuto();
        startAuto();
      };

      item.addEventListener("mouseenter", stopAuto);
      item.addEventListener("mouseleave", startAuto);

      let startX = null;
      track.addEventListener("touchstart", e => {
        startX = e.touches[0].clientX;
        stopAuto();
      }, { passive: true });

      track.addEventListener("touchend", e => {
        if (startX === null) return;
        const dx = e.changedTouches[0].clientX - startX;
        startX = null;
        if (Math.abs(dx) > 40) stepHome(track, dots, dx < 0 ? 1 : -1);
        startAuto();
      }, { passive: true });

      carousel.addEventListener("click", (e) => e.stopPropagation());
      dots.addEventListener("click", (e) => e.stopPropagation());

      // ✅ 초기: 0번 주변만 살짝 프리로드(원치 않으면 radius=0으로)
      hydrateHomeAround(track, 0, 1);

      startAuto();
    }

    item.addEventListener("click", () => {
      window.location.href = "news.html";
    });

    return item;
  }

  async function loadLatestNews() {
    if (!latestWrap) return;

    try {
      const res = await fetch("content/news.json?v=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error("news.json load failed");
      const data = await res.json();
      const posts = Array.isArray(data.posts) ? data.posts : [];

      posts.sort((a, b) => safeDate(b.date) - safeDate(a.date));
      const top4 = posts.slice(0, 4);

      latestWrap.innerHTML = "";
      if (!top4.length) {
        const empty = document.createElement("div");
        empty.className = "home-news-empty";
        empty.textContent = "등록된 소식이 없습니다.";
        latestWrap.appendChild(empty);
        return;
      }

      top4.forEach(p => latestWrap.appendChild(renderHomePost(p)));
    } catch (e) {
      console.error(e);
      latestWrap.innerHTML = `<div class="home-news-empty">News 데이터를 불러오지 못했습니다. (content/news.json 확인)</div>`;
    }
  }

  loadLatestNews();
</script>

</body>
</html>