<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SCI | SFPL</title>
  <link rel="stylesheet" href="../styles.css" />

  <style>
    .page-wrap { max-width: 1650px; margin: 56px auto; padding: 0 24px; }
    .page-title { font-size: 30px; font-weight: 800; margin: 0 0 18px; }
    .subdesc { color:#666; line-height:1.8; margin: 0 0 22px; }

    /* year nav */
    .year-nav{
      display: inline-flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.04);
      margin: 0 auto 26px;
    }
    .year-nav a{
      display:inline-block;
      padding: 8px 12px;
      border-radius: 999px;
      text-decoration:none;
      background: white;
      border: 1px solid rgba(0,0,0,.08);
      color:#111;
      font-weight: 600;
    }
    .year-nav a:hover{ border-color: rgba(0,0,0,.18); }

    /* section */
    .year-section { margin: 34px 0; }
    .year-title {
      font-size: 22px; font-weight: 800;
      margin: 0 0 14px;
      padding-top: 10px;
    }

    /* card list */
    .pub-list { display:flex; flex-direction:column; gap:14px; }
    .pub-card{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap: 14px;
      padding: 14px;
      border-radius: 16px;
      background: #fff;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 10px 30px rgba(0,0,0,.04);
    }
   .pub-card{
  grid-template-columns: auto 1fr;
  gap: 14px;
}


    .pub-journal{ font-size: 16px; font-weight: 400; margin: 0 0 6px; }
    .pub-year{ font-size: 16px; font-weight: 400; margin: 0 0 6px; }
    .pub-vol{ font-size: 16px; font-weight: 400; margin: 0 0 6px; }
    .pub-page{ font-size: 16px; font-weight: 400; margin: 0 0 6px; }
    .pub-meta{ color:#444; line-height:1.75; margin: 0 0 10px; white-space: pre-wrap; }
    .pub-link a{ text-decoration:none; font-weight:700; }

    .empty{
      padding: 14px;
      border-radius: 14px;
      background: rgba(0,0,0,.04);
      color:#666;
    }

@media (max-width: 900px){
  .pub-card{
    display: grid;
    grid-template-columns: 1fr !important;
    grid-template-areas:
      "thumb"
      "body";
    gap: 12px !important;
  }

  .pub-thumb{ grid-area: thumb; }
  .pub-body{  grid-area: body; }

  /* 모바일에서 썸네일은 가로로 예쁘게 */
  .thumb{
    width: 100% !important;
    height: auto !important;
    aspect-ratio: auto !important;  /* 이 줄이 중요 */
  }

.thumb img{
  width: 100%;
  height: auto;           /* 핵심: 비율 유지하면서 세로 자동 */
  object-fit: contain;    /* cover -> contain */
}
}


    /* ===== layout centering + compact year-nav ===== */
    .page-wrap-wide{
      width: min(1650px, calc(100% - 48px));
      margin: 20px auto;
      padding: 0 24px;
    }
    .page-title, .subdesc{ text-align: center; }

    #yearNav.year-nav{
      width: fit-content !important;
      display: flex !important;
      justify-content: center;
      margin: 0 auto 26px !important;
      padding: 10px 12px !important;
      background: rgba(0,0,0,.04);
      border-radius: 14px;
    }

    .year-section{
      width: min(1200px, 100%);
      margin: 34px auto;
    }

    .year-section .empty{
      width: 70%;
      margin: 14px auto 24px;
    }

    .year-title{
      width: 70%;
      margin: 14px auto 24px;
      text-align: left;
    }

    /* ===== mobile gutters tighten ===== */
@media (max-width: 900px){
  .page-wrap-wide{
    width: 100% !important;      /* calc(100% - 48px) 제거 */
    padding: 0 16px !important;  /* 좌우 여백 12px 정도로 */
    margin: 18px auto !important;
  }

  .year-section{
    width: 100% !important;      /* 섹션도 꽉 차게 */
    margin: 18px auto !important;
  }

  .pub-card{
    padding: 10px 12px !important; /* 카드 내부 여백도 살짝 컴팩트 */
  }
}

.pub-note-inline{
  font-size: 16px;      /* 제목과 동일한 크기 */
  font-weight: 400;        /* bold 제거 */
  color: #d11;             /* 붉은색 */
  margin-left: 6px;
  white-space: nowrap;     /* 줄바꿈 방지 */
}

.pub-title{
  font-size: 18px;     /* ← 원하는 크기로 조절 (예: 20~24px) */
  font-weight: 800;   /* 제목은 bold 유지 */
  margin: 0 0 4px;
  line-height: 1.25;
}

.pub-authors{
  font-size: 16px;     /* ← authors 크기 */
  line-height: 1.6;
  color: #222;
}

.pub-authors .lab-author{
  font-weight: 700;
  text-decoration: underline;
  text-underline-offset: 2px;
}

/* ===== SCI thumbnail ===== */
/* ===== SCI thumbnail (desktop) ===== */
.thumb{
  width: 300px;           /* 가로 고정 */
  height: auto;           /* 자동 */
  border-radius: 16px;
  overflow: hidden;
  background: rgba(0,0,0,.05);
}


.thumb img{
  width: 100%;
  height: auto;           /* 핵심: 비율 유지하면서 세로 자동 */
  object-fit: contain;    /* cover -> contain */
  display: block;
}

/* 카드 그리드도 명확히 */
.pub-card{
  display: grid;
  grid-template-columns: 300px 1fr;
  gap: 18px;
  align-items: start;
}

.author-mark{
  font-size: 0.85em;
  vertical-align: super;
  margin-left: 1px;
  line-height: 0;
}



  </style>
</head>

<body class="page-flex">

  <!-- ✅ 공통 헤더 삽입 위치 -->
  <div id="site-header"></div>

  <main>
    <div class="page-wrap-wide">
      <h1 class="page-title">SCI Publications</h1>
      <nav class="year-nav" id="yearNav" aria-label="SCI year navigation"></nav>
      <div id="content"></div>
    </div>
  </main>

<div id="site-footer"></div>


 <script>
  /* =========================
     footer year
  ========================= */
  const y = document.getElementById("year");
  if (y) y.textContent = new Date().getFullYear();

  /* =========================
     header load
  ========================= */
  fetch("../header.html")
    .then(res => {
      if (!res.ok) throw new Error("header.html load failed");
      return res.text();
    })
    .then(html => {
      document.getElementById("site-header").innerHTML = html;

      document.querySelectorAll(".nav-link").forEach(a => a.classList.remove("active"));
      const desk = document.querySelector(
        '.nav-link[href="/achievement/sci.html"], .nav-link[href="../achievement/sci.html"]'
      );
      if (desk) desk.classList.add("active");

      const mob = document.querySelector(
        '#mobileNav .m-link[href="/achievement/sci.html"], #mobileNav .m-link[href="../achievement/sci.html"]'
      );
      if (mob) mob.classList.add("active");

      const btn = document.querySelector(".nav-toggle");
      const mobileNav = document.getElementById("mobileNav");
      if (btn && mobileNav) {
        btn.addEventListener("click", () => {
          const open = mobileNav.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(open));
        });
      }

      document
        .querySelectorAll(".dropdown-toggle, .mobile-nav .m-link[href='#']")
        .forEach(el => el.addEventListener("click", e => e.preventDefault()));

      document
        .querySelectorAll("#mobileNav [data-toggle='sub']")
        .forEach(t => {
          t.addEventListener("click", e => {
            e.preventDefault();
            const sub = t.nextElementSibling;
            if (sub && sub.classList.contains("m-sub")) sub.classList.toggle("open");
          });
        });
    })
    .catch(err => console.error(err));

    fetch("../footer.html")
  .then(res => {
    if (!res.ok) throw new Error("footer.html load failed");
    return res.text();
  })
  .then(html => {
    document.getElementById("site-footer").innerHTML = html;
    const y = document.getElementById("year");
    if (y) y.textContent = new Date().getFullYear();
  })
  .catch(err => console.error(err));


  /* =========================
     helpers
  ========================= */
  const slugify = s =>
    String(s || "").trim().toLowerCase().replace(/[^\w\s-]/g, "").replace(/\s+/g, "-");

  const escapeHTML = s =>
    String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");

  // ===== 이미지 경로 보정 =====
  // CMS 저장값이
  //  - "/assets/..."(상대/절대)
  //  - "assets/..."(상대)
  //  - "https://raw.githubusercontent.com/.../assets/..."(raw URL)
  // 어떤 형태든 화면에서는 가능한 한 "\/assets/..." 형태로 통일해 사용.
  const GH_OWNER  = "crchoi0305";
  const GH_REPO   = "SFPL";
  const GH_BRANCH = "main";
  const GH_RAW_BASE = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}`;

  const isAbs = url => /^https?:\/\//i.test(url) || String(url).startsWith("/");
  const rawToSitePath = (url) => {
    const s = String(url || "").trim();
    if (!s) return "";
    // raw.githubusercontent.com/.../main/assets/... -> /assets/...
    const prefix = GH_RAW_BASE + "/";
    if (s.startsWith(prefix)) return "/" + s.slice(prefix.length);
    return s;
  };

  const resolveImgSrc = p => {
    if (!p) return "";
    const s = rawToSitePath(String(p).trim());
    if (!s) return "";
    return isAbs(s) ? s : "../" + s.replace(/^\.?\//, "");
  };

  /* =========================
     핵심: 그룹 자동 생성 로직
  ========================= */
  function pickGroups(data) {
    const pubs = Array.isArray(data?.publications) ? data.publications : [];
    const posts = pubs.length ? pubs : [];

    // 1️⃣ posts에서 연도 수집
    const years = new Set();
    posts.forEach(p => {
      const y = Number(String(p.year || "").trim());
      if (Number.isFinite(y)) years.add(y);
    });

    // 2️⃣ Prior 컷오프
    const PRIOR_LABEL = "Prior to 2022";
    const CUT = 2022;

    // 3️⃣ 개별 연도 라벨 (컷오프 이상)
    const yearLabels = Array.from(years)
      .filter(y => y >= CUT)
      .sort((a,b) => b - a)
      .map(String);

    // 4️⃣ 전체 라벨 순서
    const labels = [...yearLabels, PRIOR_LABEL];

    // 5️⃣ map 초기화
    const map = new Map();
    labels.forEach(l => map.set(l, []));

    // 6️⃣ 배치
    posts.forEach(p => {
      const y = Number(String(p.year || "").trim());
      if (!Number.isFinite(y)) return;

      if (y < CUT) {
        map.get(PRIOR_LABEL).push(p);
      } else {
        const key = String(y);
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(p);
      }
    });

    return labels.map(l => ({ label: l, items: map.get(l) || [] }));
  }

  /* =========================
     card renderer
  ========================= */
  function cardHTML(item){
    const imgSrc = resolveImgSrc(item.image || item.thumbnail || item.thumb);

    const title = item.title || "";
    const authors = item.authors || "";
    const journal = item.venue || item.journal || "";
    const year = String(item.year || "").trim();
    const note = String(item.note || "").trim();

    const bib = String(item.bib || "").trim();
    let volume = "", page = "";
    if (bib) {
      const parts = bib.split(",").map(s => s.trim()).filter(Boolean);
      volume = parts[0] || "";
      page = parts.slice(1).join(", ");
    }

    const linkUrl = item.doi || item.link || item.url || "";

    const img = imgSrc
      ? `<div class="thumb"><img src="${escapeHTML(imgSrc)}" alt=""></div>`
      : `<div class="thumb"></div>`;

    const line = [
      journal && `<span class="pub-journal">${escapeHTML(journal)}</span>`,
      year && `<span class="pub-year">${escapeHTML(year)}</span>`,
      volume && `<span class="pub-vol">${escapeHTML(volume)}</span>`,
      page && `<span class="pub-page">${escapeHTML(page)}</span>`
    ].filter(Boolean).join(", ");

    const btn = linkUrl
      ? `<a class="pub-btn" href="${escapeHTML(linkUrl)}" target="_blank" rel="noopener">LINK</a>`
      : "";

    return `
      <article class="pub-card">
        ${img.replace('class="thumb"', 'class="thumb pub-thumb"')}
<div class="pub-body">

        <div>
         <h3 class="pub-title">
  ${escapeHTML(title)}
  ${note ? `<span class="pub-note-inline"> ${escapeHTML(note)}</span>` : ""}
</h3>
          <div class="pub-authors">${renderAuthors(authors)}</div>
          <div class="pub-line">${line}</div>
          ${btn}
        </div>
      </article>
    `;
  }

function renderAuthors(authors){
  // 기존 데이터(문자열) 호환
  if(typeof authors === "string") return escapeHTML(authors);

  // roles -> 기호 매핑
  const roleMarks = (roles) => {
    if(!Array.isArray(roles)) return "";
    let mark = "";
    if(roles.includes("co-first")) mark += "†";
    if(roles.includes("corresponding")) mark += "*";
    return mark ? `<sup class="author-mark">${mark}</sup>` : "";
  };

  // 새 데이터(배열) 처리
  if(Array.isArray(authors)){
    return authors
      .filter(a => a && (a.name || typeof a === "string"))
      .map(a => {
        // 문자열 author도 지원
        if(typeof a === "string"){
          return `<span class="author">${escapeHTML(a)}</span>`;
        }

        const name = a.name || "";
        const isLab = !!a.is_lab;
        const cls = isLab ? "author lab-author" : "author";
        const mark = roleMarks(a.roles);

        return `<span class="${cls}">${escapeHTML(name)}${mark}</span>`;
      })
      .join(", ");
  }

  return "";
}


  /* =========================
     init
  ========================= */
  async function loadSCI(){
    const wrap = document.getElementById("content");
    const nav = document.getElementById("yearNav");

    try{
      const res = await fetch("../content/sci.json?v=" + Date.now(), { cache: "no-store" });
      if(!res.ok) throw new Error("sci.json load failed");
      const data = await res.json();

      const groups = pickGroups(data);

      nav.innerHTML = groups
        .map(g => `<a href="#y-${slugify(g.label)}">${escapeHTML(g.label)}</a>`)
        .join("");

      wrap.innerHTML = groups.map(g => `
        <section class="year-section" id="y-${slugify(g.label)}">
          <h2 class="year-title">${escapeHTML(g.label)}</h2>
          ${
            g.items.length
              ? `<div class="pub-list">${g.items.map(cardHTML).join("")}</div>`
              : `<div class="empty">등록된 실적이 없습니다.</div>`
          }
        </section>
      `).join("");

    }catch(err){
      console.error(err);
      wrap.innerHTML = `<div class="empty">SCI 데이터를 불러오지 못했습니다.</div>`;
      nav.innerHTML = "";
    }
  }

  loadSCI();
</script>

</body>
</html>
