<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>News | SFPL</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="page-flex">

  <!-- ✅ 공통 헤더가 들어갈 자리 -->
  <div id="site-header"></div>

  <main class="page-wrap">
         <div class="page-wrap-wide news-wrap">
                <h1 class="page-title">News</h1>

      <section id="newsList" class="news-list" aria-label="News archive">
        <!-- JS render -->
      </section>
    </div>
  </main>

<div id="site-footer"></div>


<script>
  // ===== footer year =====
  const y = document.getElementById("year");
  if (y) y.textContent = new Date().getFullYear();

  // ===== GitHub Pages(/<repo>/...) 호스팅 대비 base prefix 계산 =====
  const basePrefix = (() => {
    const p = location.pathname;
    return p.endsWith('/') ? p : p.replace(/\/[^\/]*$/, '/');
  })();

  // ===== header load =====
  fetch(basePrefix + "header.html")
    .then(res => {
      if (!res.ok) throw new Error("header.html load failed");
      return res.text();
    })
    .then(html => {
      document.getElementById("site-header").innerHTML = html;

      // hamburger toggle
      const btn = document.querySelector(".nav-toggle");
      const mobileNav = document.getElementById("mobileNav");
      if (btn && mobileNav) {
        btn.addEventListener("click", () => {
          const open = mobileNav.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(open));
        });
      }

      // prevent jump for dropdown toggles (desktop + mobile '#')
      document
        .querySelectorAll(".dropdown-toggle, .mobile-nav .m-link[href='#']")
        .forEach((el) => el.addEventListener("click", (e) => e.preventDefault()));

      // mobile submenu toggle (data-toggle="sub" 사용)
      document
        .querySelectorAll("#mobileNav [data-toggle='sub']")
        .forEach((t) => {
          t.addEventListener("click", (e) => {
            e.preventDefault();
            const sub = t.nextElementSibling;
            if (sub && sub.classList.contains("m-sub")) sub.classList.toggle("open");
          });
        });
    })
    .catch(err => console.error(err));

    fetch(basePrefix + "footer.html")
  .then(res => {
    if (!res.ok) throw new Error("footer.html load failed");
    return res.text();
  })
  .then(html => {
    document.getElementById("site-footer").innerHTML = html;
    const y = document.getElementById("year");
    if (y) y.textContent = new Date().getFullYear();
  })
  .catch(err => console.error(err));


  // ===== news render =====
  const list = document.getElementById("newsList");

  function el(tag, cls, text) {
    const n = document.createElement(tag);
    if (cls) n.className = cls;
    if (text !== undefined) n.textContent = text;
    return n;
  }

  function safeDate(d) {
    // supports: YYYY-MM-DD, YYYY.MM.DD, YYYY/MM/DD
    if (!d) return 0;
    const s = String(d).trim().replaceAll(".", "-").replaceAll("/", "-");
    const t = Date.parse(s);
    return Number.isFinite(t) ? t : 0;
  }

  function formatDate(d) {
    // YYYY-MM-DD -> YYYY.MM.DD (보이기용), 이미 점(.)이면 그대로
    if (!d) return "";
    const m = String(d).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(m)) return m.replaceAll("-", ".");
    return m;
  }

  // ===== GitHub Raw (이미지 CDN처럼 사용) 설정 =====
  const GH_OWNER  = "crchoi0305";
  const GH_REPO   = "SFPL";
  const GH_BRANCH = "main";
  const GH_RAW_BASE = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}`;

  function isHttpUrl(p) {
    return /^https?:\/\//i.test(String(p));
  }

  // ===== 이미지 src를 "로컬 경로 우선 + 실패 시 raw URL"로 세팅하기 위한 해석기 =====
  function resolveImgSources(v) {
    if (!v) return { primary: "", fallback: "" };
    const src = (typeof v === "string") ? v : (v && typeof v === "object" ? (v.src || v.image || "") : "");
    const s = String(src || "").trim();
    if (!s) return { primary: "", fallback: "" };

    // 1) raw URL로 저장된 경우: 같은 파일을 로컬 경로로 먼저 시도
    if (isHttpUrl(s) && s.startsWith(GH_RAW_BASE + "/")) {
      let rel = s.slice((GH_RAW_BASE + "/").length); // e.g. assets/news/... or content/assets/news/...
      // ✅ 과거 데이터 호환: content/assets/news -> assets/news 로 보정
      rel = rel.replace(/^content\/assets\/news\//, "assets/news/");
      const primary = (basePrefix + rel).replace(/\/\/+/, "/");
      return { primary, fallback: s };
    }

    // 2) 외부 URL이면 그대로 사용
    if (isHttpUrl(s)) return { primary: s, fallback: "" };

    // 3) 로컬 경로로 우선 시도
    let clean = s.replace(/^\.?\//, "").replace(/^\/+/, "");

    // ✅ 파일명만 오는 경우 -> assets/news로 보정
    if (!clean.includes("/")) clean = "assets/news/" + clean;
    // ✅ 과거 데이터 호환: content/assets/news -> assets/news
    clean = clean.replace(/^content\/assets\/news\//, "assets/news/");

    const primary = (basePrefix + clean).replace(/\/\/+/, "/");
    const fallback = `${GH_RAW_BASE}/${clean}`;
    return { primary, fallback };
  }

  function setImgWithFallback(img, sources) {
    if (!img || !sources) return;
    const primary = sources.primary || "";
    const fallback = sources.fallback || "";
    img.src = primary || fallback || "";
    if (primary && fallback && primary !== fallback) {
      img.onerror = () => {
        img.onerror = null;
        img.src = fallback;
      };
    }
  }

  // ====== mobile carousel helpers ======
  function ensureCarouselCSSOnce() {
    if (document.getElementById("newsCarouselCSS")) return;

    const style = document.createElement("style");
    style.id = "newsCarouselCSS";
    style.textContent = `
      /* desktop: 기존 gallery */
      .news-gallery { display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:center; }
      .news-imglink { display:block; }
      .news-img { display:block; height:auto; max-width:100%; border-radius:12px; }

      /* mobile: carousel */
      @media (max-width: 640px){
        .news-gallery { display:block; } /* 모바일에선 carousel로 치환 */
        .news-carousel { position:relative; width:100%; }
        .news-track {
          display:flex;
          overflow-x:auto;
          scroll-snap-type:x mandatory;
          -webkit-overflow-scrolling: touch;
          gap:12px;
          padding: 8px 0 4px;
          scrollbar-width:none;
        }
        .news-track::-webkit-scrollbar{ display:none; }

        .news-slide{
          flex: 0 0 100%;
          scroll-snap-align:center;
        }

        .news-slide a{ display:block; }
        .news-slide img{
          width:100%;
          height:auto;
          display:block;
          border-radius:14px;
          object-fit:cover;
        }

        .news-dots{
          display:flex;
          justify-content:center;
          gap:8px;
          padding: 10px 0 0;
        }
        .news-dot{
          width:7px; height:7px;
          border-radius:999px;
          background: rgba(0,0,0,.25);
          border:0;
          padding:0;
        }
        .news-dot.is-active{
          background: rgba(0,0,0,.75);
        }
      }
    `;
    document.head.appendChild(style);
  }

  function buildCarousel(imgs, titleText) {
    ensureCarouselCSSOnce();

    const wrap = el("div", "news-carousel");

    const track = el("div", "news-track");
    track.setAttribute("role", "group");
    track.setAttribute("aria-label", "News images");

    const dots = el("div", "news-dots");

    const slides = imgs.map((srcObj, i) => {
      const slide = el("div", "news-slide");

      const a = document.createElement("a");
      a.href = (srcObj.primary || srcObj.fallback);
      a.target = "_blank";
      a.rel = "noopener";
      a.className = "news-imglink";

      const img = document.createElement("img");
      setImgWithFallback(img, srcObj);
      img.alt = (titleText ? titleText + " - " : "") + (i + 1);
      img.loading = "lazy";
      img.className = "news-img";
      a.appendChild(img);

      slide.appendChild(a);
      track.appendChild(slide);

      const dot = document.createElement("button");
      dot.type = "button";
      dot.className = "news-dot" + (i === 0 ? " is-active" : "");
      dot.setAttribute("aria-label", "Go to image " + (i + 1));
      dot.addEventListener("click", () => {
        // 해당 슬라이드로 스크롤
        const left = slide.offsetLeft - track.offsetLeft;
        track.scrollTo({ left, behavior: "smooth" });
      });
      dots.appendChild(dot);

      return slide;
    });

    // dots active sync
    function setActive(idx) {
      const children = dots.children;
      for (let i = 0; i < children.length; i++) {
        children[i].classList.toggle("is-active", i === idx);
      }
    }

    // 현재 스크롤 위치 기준으로 가장 가까운 슬라이드 찾기
    let raf = null;
    track.addEventListener("scroll", () => {
      if (raf) cancelAnimationFrame(raf);
      raf = requestAnimationFrame(() => {
        const center = track.scrollLeft + track.clientWidth / 2;
        let bestIdx = 0;
        let bestDist = Infinity;
        slides.forEach((s, i) => {
          const sCenter = s.offsetLeft - track.offsetLeft + s.clientWidth / 2;
          const dist = Math.abs(center - sCenter);
          if (dist < bestDist) { bestDist = dist; bestIdx = i; }
        });
        setActive(bestIdx);
      });
    }, { passive: true });

    wrap.appendChild(track);
    if (imgs.length > 1) wrap.appendChild(dots);
    return wrap;
  }

  function renderPost(p) {
    const card = el("article", "news-card");

    const head = el("div", "news-head");
    const date = el("div", "news-date", formatDate(p.date || ""));
    const title = el("h2", "news-title", p.title || "Untitled");
    head.appendChild(date);
    head.appendChild(title);
    card.appendChild(head);

    // ✅ desc 출력 (문단)
    if (p.desc) {
      const desc = el("p", "news-desc", p.desc);
      card.appendChild(desc);
    }

    // body (bullets) - 기존 호환 유지
    const bodyWrap = el("div", "news-body");
    const lines = Array.isArray(p.body) ? p.body : (p.body ? [String(p.body)] : []);
    if (lines.length) {
      const ul = el("ul", "news-bullets");
      lines.forEach(t => {
        const li = document.createElement("li");
        li.textContent = t;
        ul.appendChild(li);
      });
      bodyWrap.appendChild(ul);
    }
    if (bodyWrap.childNodes.length) card.appendChild(bodyWrap);

    // images row
    const imgsRaw = Array.isArray(p.images) ? p.images : [];
    const imgs = imgsRaw.map(resolveImgSources).filter(o => (o && (o.primary || o.fallback)));

    if (imgs.length) {
      // ✅ 모바일: 캐러셀 / 데스크탑: 기존 갤러리
      const isMobile = window.matchMedia && window.matchMedia("(max-width: 640px)").matches;

      if (isMobile) {
        card.appendChild(buildCarousel(imgs, p.title || ""));
      } else {
        const gallery = el("div", "news-gallery");
        imgs.forEach((srcObj, i) => {
          const a = document.createElement("a");
          a.href = (srcObj.primary || srcObj.fallback);
          a.target = "_blank";
          a.rel = "noopener";
          a.className = "news-imglink";

          const img = document.createElement("img");
          setImgWithFallback(img, srcObj);
          img.alt = (p.title ? p.title + " - " : "") + (i + 1);
          img.loading = "lazy";
          img.className = "news-img";
          a.appendChild(img);

          gallery.appendChild(a);
        });
        card.appendChild(gallery);
      }
    }

    // links
    const links = Array.isArray(p.links) ? p.links : [];
    if (links.length) {
      const linkRow = el("div", "news-links");
      links.forEach((l) => {
        if (!l || !l.url) return;
        const a = document.createElement("a");
        a.href = l.url;
        a.target = "_blank";
        a.rel = "noopener";
        a.className = "news-linkbtn";
        a.textContent = l.label || "Link";
        linkRow.appendChild(a);
      });
      card.appendChild(linkRow);
    }

    return card;
  }

  async function init() {
    try {
      // ✅ cache-bust 포함
      const res = await fetch(basePrefix + "content/news.json?v=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error("news.json load failed");
      const data = await res.json();
      const posts = Array.isArray(data.posts) ? data.posts : [];

      // 최신이 위로: date 내림차순
      posts.sort((a, b) => safeDate(b.date) - safeDate(a.date));

      if (!posts.length) {
        list.appendChild(el("div", "news-empty", "등록된 소식이 없습니다."));
        return;
      }

      posts.forEach(p => list.appendChild(renderPost(p)));

      // ✅ 리사이즈로 모바일/데스크탑 전환 시(회전 포함) 다시 그리기
      // (캐러셀 <-> 갤러리 전환이 필요해서 간단히 한번 재렌더)
      let t = null;
      window.addEventListener("resize", () => {
        clearTimeout(t);
        t = setTimeout(() => {
          if (!list) return;
          // 현재 렌더된 DOM을 지우고 동일 데이터로 다시 렌더
          list.innerHTML = "";
          posts.forEach(p => list.appendChild(renderPost(p)));
        }, 150);
      });
    } catch (e) {
      console.error(e);
      list.appendChild(el("div", "news-empty", "News 데이터를 불러오지 못했습니다. (content/news.json 확인)"));
    }
  }

  init();
</script>



</body>
</html>
