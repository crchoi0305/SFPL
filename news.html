<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>News | SFPL</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="page-flex">
  <div id="site-header"></div>

  <main class="page-wrap">
    <div class="page-wrap-wide news-wrap">
      <h1 class="page-title">News</h1>

      <section id="newsList" class="news-list" aria-label="News archive">
        <!-- JS render -->
      </section>
    </div>
  </main>

  <div id="site-footer"></div>

<script>
  // ===== GitHub Pages(/<repo>/...) + Custom domain(/) 모두 대응 basePrefix =====
  const basePrefix = (() => {
    const parts = location.pathname.split("/").filter(Boolean);
    if (location.hostname.endsWith("github.io")) {
      const repo = parts[0] || "";
      return "/" + repo + "/";
    }
    return "/";
  })();

  // ===== header load =====
  fetch(basePrefix + "header.html")
    .then(res => { if (!res.ok) throw new Error("header.html load failed"); return res.text(); })
    .then(html => {
      document.getElementById("site-header").innerHTML = html;

      const btn = document.querySelector(".nav-toggle");
      const mobileNav = document.getElementById("mobileNav");
      if (btn && mobileNav) {
        btn.addEventListener("click", () => {
          const open = mobileNav.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(open));
        });
      }

      document
        .querySelectorAll(".dropdown-toggle, .mobile-nav .m-link[href='#']")
        .forEach((el) => el.addEventListener("click", (e) => e.preventDefault()));

      document
        .querySelectorAll("#mobileNav [data-toggle='sub']")
        .forEach((t) => {
          t.addEventListener("click", (e) => {
            e.preventDefault();
            const sub = t.nextElementSibling;
            if (sub && sub.classList.contains("m-sub")) sub.classList.toggle("open");
          });
        });
    })
    .catch(err => console.error(err));

  // ===== footer load =====
  fetch(basePrefix + "footer.html")
    .then(res => { if (!res.ok) throw new Error("footer.html load failed"); return res.text(); })
    .then(html => {
      document.getElementById("site-footer").innerHTML = html;
      const y = document.getElementById("year");
      if (y) y.textContent = new Date().getFullYear();
    })
    .catch(err => console.error(err));

  // ===== helpers =====
  const list = document.getElementById("newsList");

  function el(tag, cls, text) {
    const n = document.createElement(tag);
    if (cls) n.className = cls;
    if (text !== undefined) n.textContent = text;
    return n;
  }

  function safeDate(d) {
    if (!d) return 0;
    const s = String(d).trim().replaceAll(".", "-").replaceAll("/", "-");
    const t = Date.parse(s);
    return Number.isFinite(t) ? t : 0;
  }

  function formatDate(d) {
    if (!d) return "";
    const m = String(d).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(m)) return m.replaceAll("-", ".");
    return m;
  }

  function isHttpUrl(p) {
    return /^https?:\/\//i.test(String(p));
  }

  // ===== Netlify Image CDN (photo와 동일한 스타일) =====
  function nlImg(url, w, q = 72, fm = "webp") {
    if (!url) return "";
    const s = String(url).trim();
    if (!s) return "";
    if (isHttpUrl(s)) return s;               // 외부 URL은 그대로
    const u = encodeURI(s.startsWith("/") ? s : ("/" + s)); // "/" 유지
    return `/.netlify/images?url=${u}&w=${w}&q=${q}&fm=${fm}`;
  }

  // ===== GitHub Raw fallback (로컬 경로가 깨졌을 때만) =====
  const GH_OWNER  = "crchoi0305";
  const GH_REPO   = "SFPL";
  const GH_BRANCH = "main";
  const GH_RAW_BASE = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}`;

  // news 이미지 경로 정규화: 어떤 입력이 와도 "/content/assets/news/..." 형태로
  function normalizeNewsRelPath(p){
    let rel = String(p || "").trim();
    rel = rel.replace(/^https?:\/\/[^/]+\/?/, ""); // 도메인 섞이면 제거
    rel = rel.replace(/^\/+/, "");
    rel = rel.replace(/^\.?\//, "");

    // content/content 제거
    rel = rel.replace(/^content\/content\//, "content/");

    // assets/news -> content/assets/news
    if (rel.startsWith("assets/news/")) rel = rel.replace(/^assets\/news\//, "content/assets/news/");
    // news/ -> content/assets/news/
    if (rel.startsWith("news/")) rel = rel.replace(/^news\//, "content/assets/news/");
    // 파일명만 -> content/assets/news/파일명
    if (!rel.includes("/")) rel = "content/assets/news/" + rel;

    // 이미 content/assets/news/ 이면 OK
    if (!rel.startsWith("content/assets/news/")) {
      // 혹시 assets/.. 등 이상한 케이스는 강제로 news 아래로
      rel = "content/assets/news/" + rel.replace(/^content\/assets\/news\//, "");
    }
    return rel;
  }

  function resolveImgSources(v) {
    if (!v) return { primary: "", fallback: "" };

    const src = (typeof v === "string")
      ? v
      : (v && typeof v === "object" ? (v.src || v.image || "") : "");

    const s = String(src || "").trim();
    if (!s) return { primary: "", fallback: "" };

    // 1) raw URL로 저장된 경우: 로컬 먼저, raw fallback
    if (isHttpUrl(s) && s.startsWith(GH_RAW_BASE + "/")) {
      let rel = s.slice((GH_RAW_BASE + "/").length);
      rel = normalizeNewsRelPath(rel);

      const primary = (basePrefix + rel).replace(/\/\/+/g, "/");
      const fallback = s;
      return { primary, fallback };
    }

    // 2) 외부 URL이면 그대로
    if (isHttpUrl(s)) return { primary: s, fallback: "" };

    // 3) 로컬 경로: 정규화 후 primary, raw fallback 생성
    const rel = normalizeNewsRelPath(s);
    const primary = (basePrefix + rel).replace(/\/\/+/g, "/");
    const fallback = `${GH_RAW_BASE}/${rel}`;
    return { primary, fallback };
  }

  // ✅ 핵심: primary가 로컬(/...)이면 Netlify Image CDN으로 가볍게 받아오고, 실패 시 raw fallback
  function setImgWithFallback(img, sources) {
    if (!img || !sources) return;

    const primary = sources.primary || "";
    const fallback = sources.fallback || "";

    if (primary && primary.startsWith("/")) {
      // 뉴스 카드 이미지 표시 사이즈 기준(가로 폭)로 리사이즈
      img.src = nlImg(primary, 900);
      img.srcset = `${nlImg(primary, 600)} 600w, ${nlImg(primary, 900)} 900w, ${nlImg(primary, 1200)} 1200w`;
      img.sizes = "(max-width: 640px) 92vw, (max-width: 1200px) 800px, 900px";
    } else {
      img.src = primary || fallback || "";
    }

    img.loading = "lazy";
    img.decoding = "async";

    img.onerror = () => {
      if (fallback && img.src !== fallback) {
        img.src = fallback;
        return;
      }
      img.onerror = null;
    };
  }

  function renderPost(p) {
    const card = el("article", "news-card");

    const head = el("div", "news-head");
    const date = el("div", "news-date", formatDate(p.date || ""));
    const title = el("h2", "news-title", p.title || "Untitled");
    head.appendChild(date);
    head.appendChild(title);
    card.appendChild(head);

    if (p.desc) {
      const desc = el("p", "news-desc", p.desc);
      card.appendChild(desc);
    }

    const lines = Array.isArray(p.body) ? p.body : (p.body ? [String(p.body)] : []);
    if (lines.length) {
      const bodyWrap = el("div", "news-body");
      const ul = el("ul", "news-bullets");
      lines.forEach(t => {
        const li = document.createElement("li");
        li.textContent = t;
        ul.appendChild(li);
      });
      bodyWrap.appendChild(ul);
      card.appendChild(bodyWrap);
    }

    // images (캐러셀 없음: 그냥 갤러리)
    const imgsRaw = Array.isArray(p.images) ? p.images : [];
    const imgs = imgsRaw.map(resolveImgSources).filter(o => (o && (o.primary || o.fallback)));

    if (imgs.length) {
      const gallery = el("div", "news-gallery");
      imgs.forEach((srcObj, i) => {
        const a = document.createElement("a");
        a.href = (srcObj.primary || srcObj.fallback);
        a.target = "_blank";
        a.rel = "noopener";
        a.className = "news-imglink";

        const img = document.createElement("img");
        img.className = "news-img";
        setImgWithFallback(img, srcObj);
        img.alt = (p.title ? p.title + " - " : "") + (i + 1);

        a.appendChild(img);
        gallery.appendChild(a);
      });
      card.appendChild(gallery);
    }

    // links
    const links = Array.isArray(p.links) ? p.links : [];
    if (links.length) {
      const linkRow = el("div", "news-links");
      links.forEach((l) => {
        if (!l || !l.url) return;
        const a = document.createElement("a");
        a.href = l.url;
        a.target = "_blank";
        a.rel = "noopener";
        a.className = "news-linkbtn";
        a.textContent = l.label || "Link";
        linkRow.appendChild(a);
      });
      card.appendChild(linkRow);
    }

    return card;
  }

  async function init() {
    try {
      const res = await fetch(basePrefix + "content/news.json?v=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error("news.json load failed");
      const data = await res.json();
      const posts = Array.isArray(data.posts) ? data.posts : [];

      posts.sort((a, b) => safeDate(b.date) - safeDate(a.date));

      if (!posts.length) {
        list.appendChild(el("div", "news-empty", "등록된 소식이 없습니다."));
        return;
      }

      posts.forEach(p => list.appendChild(renderPost(p)));
    } catch (e) {
      console.error(e);
      list.appendChild(el("div", "news-empty", "News 데이터를 불러오지 못했습니다. (content/news.json 확인)"));
    }
  }

  init();
</script>
</body>
</html>